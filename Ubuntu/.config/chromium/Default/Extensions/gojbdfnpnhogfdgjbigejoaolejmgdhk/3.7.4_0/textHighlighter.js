/*
The MIT License (MIT)
Copyright (c) 2011 - 2014 mirz <mirz.hq@gmail.com>
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
!function(e){"use strict";function t(e,t){return g(e).color()===g(t).color()}function n(e,t){e=e||{};for(var n in t)t.hasOwnProperty(n)&&void 0===e[n]&&(e[n]=t[n]);return e}function i(e){return e.filter(function(e,t,n){return n.indexOf(e)===t})}function o(e){var t=e.startContainer,n=e.endContainer,i=e.commonAncestorContainer,o=!0;if(0===e.endOffset){for(;!n.previousSibling&&n.parentNode!==i;)n=n.parentNode;n=n.previousSibling}else n.nodeType===d.TEXT_NODE?e.endOffset<n.nodeValue.length&&n.splitText(e.endOffset):e.endOffset>0&&(n=n.childNodes.item(e.endOffset-1));return t.nodeType===d.TEXT_NODE?e.startOffset===t.nodeValue.length?o=!1:e.startOffset>0&&(t=t.splitText(e.startOffset),n===t.previousSibling&&(n=t)):t=e.startOffset<t.childNodes.length?t.childNodes.item(e.startOffset):t.nextSibling,{startContainer:t,endContainer:n,goDeeper:o}}function r(e,t){e.sort(function(e,n){return g(t?n:e).parents().length-g(t?e:n).parents().length})}function s(e){var t=[],n={},i=[];return e.forEach(function(e){var i=e.getAttribute(h);"undefined"==typeof n[i]&&(n[i]=[],t.push(i)),n[i].push(e)}),t.forEach(function(e){var t=n[e];i.push({chunks:t,timestamp:e,toString:function(){return t.map(function(e){return e.textContent}).join("")}})}),i}function l(e,t){if(!e)throw"Missing anchor element";this.el=e,this.options=n(t,{color:"#ffff7b",enabled:!1,highlightedClass:"highlighted",contextClass:"highlighter-context",onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}}),this.boundStartDragHandler=this.startDragHandler.bind(this),this.boundHighlightHandler=this.highlightHandler.bind(this),this.isCurrentlyHighlighting=!1,this.options.enabled&&this.enable()}var a="data-highlighted",h="data-timestamp",d={ELEMENT_NODE:1,TEXT_NODE:3},u=["SCRIPT","STYLE","SELECT","OPTION","BUTTON","OBJECT","APPLET","VIDEO","AUDIO","CANVAS","EMBED","PARAM","METER","PROGRESS"],g=function(e){return{addClass:function(t){e.classList?e.classList.add(t):e.className+=" "+t},removeClass:function(t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t+"(\\b|$)","gi")," ")},prepend:function(t){for(var n=Array.prototype.slice.call(t),i=n.length;i--;)e.insertBefore(n[i],e.firstChild)},append:function(t){for(var n=Array.prototype.slice.call(t),i=0,o=n.length;i<o;++i)e.appendChild(n[i])},insertAfter:function(t){return t.parentNode.insertBefore(e,t.nextSibling)},insertBefore:function(t){return t.parentNode.insertBefore(e,t)},remove:function(){e.parentNode.removeChild(e),e=null},contains:function(t){return e!==t&&e.contains(t)},wrap:function(t){return e.parentNode&&e.parentNode.insertBefore(t,e),t.appendChild(e),t},unwrap:function(){var t,n=Array.prototype.slice.call(e.childNodes);return n.forEach(function(e){t=e.parentNode,g(e).insertBefore(e.parentNode),g(t).remove()}),n},parents:function(){for(var t,n=[];t=e.parentNode;)n.push(t),e=t;return n},normalizeTextNodes:function(){if(e){if(e.nodeType===d.TEXT_NODE)for(;e.nextSibling&&e.nextSibling.nodeType===d.TEXT_NODE;)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else g(e.firstChild).normalizeTextNodes();g(e.nextSibling).normalizeTextNodes()}},color:function(){return e.style.backgroundColor},fromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes},getRange:function(){var t,n=g(e).getSelection();return n.rangeCount>0&&(t=n.getRangeAt(0)),t},removeAllRanges:function(){var t=g(e).getSelection();t.removeAllRanges()},getSelection:function(){return g(e).getWindow().getSelection()},getWindow:function(){return g(e).getDocument().defaultView},getDocument:function(){return e.ownerDocument||e}}};l.prototype.enable=function(){this.bindEvents(this.el),g(this.el).addClass(this.options.contextClass),this.options.enabled=!0},l.prototype.disable=function(){this.unbindEvents(this.el),g(this.el).removeClass(this.options.contextClass),this.options.enabled=!1},l.prototype.toggle=function(){this.options.enabled?this.disable():this.enable()},l.prototype.isEnabled=function(){return this.options.enabled},l.prototype.startDragHandler=function(){this.isCurrentlyHighlighting=!0},l.prototype.highlightHandler=function(){this.isCurrentlyHighlighting&&(this.isCurrentlyHighlighting=!1,this.doHighlight())},l.prototype.bindEvents=function(e){e.addEventListener("mousedown",this.boundStartDragHandler),e.addEventListener("touchstart",this.boundStartDragHandler),window.addEventListener("mouseup",this.boundHighlightHandler),window.addEventListener("touchend",this.boundHighlightHandler)},l.prototype.unbindEvents=function(e){e.removeEventListener("mousedown",this.boundStartDragHandler),e.removeEventListener("touchstart",this.boundStartDragHandler),window.removeEventListener("mouseup",this.boundHighlightHandler),window.removeEventListener("touchend",this.boundHighlightHandler)},l.prototype.doHighlight=function(e){var t,n,i,o,r=g(this.el).getRange();r&&!r.collapsed&&(this.options.onBeforeHighlight(r)===!0&&(o=+new Date,t=l.createWrapper(this.options),t.setAttribute(h,o),n=this.highlightRange(r,t),i=this.normalizeHighlights(n),this.options.onAfterHighlight(r,i,o)),e||g(this.el).removeAllRanges())},l.prototype.highlightRange=function(e,t){if(!e||e.collapsed)return[];var n,i,r,s=o(e),l=s.startContainer,h=s.endContainer,c=s.goDeeper,p=!1,f=l,v=[];do{if(!f)break;c&&f.nodeType===d.TEXT_NODE&&(u.indexOf(f.parentNode.tagName)===-1&&""!==f.nodeValue.trim()&&(i=t.cloneNode(!0),i.setAttribute(a,!0),r=f.parentNode,(g(this.el).contains(r)||r===this.el)&&(n=g(f).wrap(i),v.push(n))),c=!1),f!==h||h.hasChildNodes()&&c||(p=!0),f.tagName&&u.indexOf(f.tagName)>-1&&(h.parentNode===f&&(p=!0),c=!1),c&&f.hasChildNodes()?f=f.firstChild:f.nextSibling?(f=f.nextSibling,c=!0):(f=f.parentNode,c=!1)}while(!p);return v},l.prototype.normalizeHighlights=function(e){var t;return this.flattenNestedHighlights(e),this.mergeSiblingHighlights(e),t=e.filter(function(e){return e.parentElement?e:null}),t=i(t),t.sort(function(e,t){return e.offsetTop-t.offsetTop||e.offsetLeft-t.offsetLeft}),t},l.prototype.flattenNestedHighlights=function(e){function n(){var n=!1;return e.forEach(function(i,r){var s=i.parentElement,l=s.previousSibling,a=s.nextSibling;o.isHighlight(s)&&(t(s,i)?(s.replaceChild(i.firstChild,i),e[r]=s,n=!0):(i.nextSibling||(g(i).insertBefore(a||s),n=!0),i.previousSibling||(g(i).insertAfter(l||s),n=!0),s.hasChildNodes()||g(s).remove()))}),n}var i,o=this;r(e,!0);do i=n();while(i)},l.prototype.mergeSiblingHighlights=function(e){function n(e,n){return n&&n.nodeType===d.ELEMENT_NODE&&t(e,n)&&i.isHighlight(n)}var i=this;e.forEach(function(e){var t=e.previousSibling,i=e.nextSibling;n(e,t)&&(g(e).prepend(t.childNodes),g(t).remove()),n(e,i)&&(g(e).append(i.childNodes),g(i).remove()),g(e).normalizeTextNodes()})},l.prototype.setColor=function(e){this.options.color=e},l.prototype.getColor=function(){return this.options.color},l.prototype.removeHighlights=function(e){function t(e){var t=e.previousSibling,n=e.nextSibling;t&&t.nodeType===d.TEXT_NODE&&(e.nodeValue=t.nodeValue+e.nodeValue,g(t).remove()),n&&n.nodeType===d.TEXT_NODE&&(e.nodeValue=e.nodeValue+n.nodeValue,g(n).remove())}function n(e){var n=g(e).unwrap();n.forEach(function(e){t(e)})}var i=e||this.el,o=this.getHighlights({container:i}),s=this;r(o,!0),o.forEach(function(e){s.options.onRemoveHighlight(e)===!0&&n(e)})},l.prototype.getHighlights=function(e){e=n(e,{container:this.el,andSelf:!0,grouped:!1});var t=e.container.querySelectorAll("["+a+"]"),i=Array.prototype.slice.call(t);return e.andSelf===!0&&e.container.hasAttribute(a)&&i.push(e.container),e.grouped&&(i=s(i)),i},l.prototype.isHighlight=function(e){return e&&e.nodeType===d.ELEMENT_NODE&&e.hasAttribute(a)},l.prototype.serializeHighlights=function(){function e(e,t){var n,i=[];do n=Array.prototype.slice.call(e.parentNode.childNodes),i.unshift(n.indexOf(e)),e=e.parentNode;while(e!==t||!e);return i}var t=this.getHighlights(),n=this.el,i=[];return r(t,!1),t.forEach(function(t){var o=0,r=t.textContent.length,s=e(t,n),l=t.cloneNode(!0);l.innerHTML="",l=l.outerHTML,t.previousSibling&&t.previousSibling.nodeType===d.TEXT_NODE&&(o=t.previousSibling.length),i.push([l,t.textContent,s.join(":"),o,r])}),JSON.stringify(i)},l.prototype.deserializeHighlights=function(e){function t(e){for(var t,n,r,s={wrapper:e[0],text:e[1],path:e[2].split(":"),offset:e[3],length:e[4]},l=s.path.pop(),a=o.el;r=s.path.shift();)a=a.childNodes[r];a.childNodes[l-1]&&a.childNodes[l-1].nodeType===d.TEXT_NODE&&(l-=1),a=a.childNodes[l],t=a.splitText(s.offset),t.splitText(s.length),t.nextSibling&&!t.nextSibling.nodeValue&&g(t.nextSibling).remove(),t.previousSibling&&!t.previousSibling.nodeValue&&g(t.previousSibling).remove(),n=g(t).wrap(g().fromHTML(s.wrapper)[0]),i.push(n)}var n,i=[],o=this;if(!e)return i;try{n=JSON.parse(e)}catch(e){throw"Can't parse JSON: "+e}return n.forEach(function(e){try{t(e)}catch(e){console&&console.warn&&console.warn("Can't deserialize highlight descriptor. Cause: "+e)}}),i},l.prototype.find=function(e,t){var n=g(this.el).getWindow(),i=n.scrollX,o=n.scrollY,r="undefined"==typeof t||t;if(g(this.el).removeAllRanges(),n.find)for(;n.find(e,r);)this.doHighlight(!0);else if(n.document.body.createTextRange){var s=n.document.body.createTextRange();for(s.moveToElementText(this.el);s.findText(e,1,r?4:0)&&(g(this.el).contains(s.parentElement())||s.parentElement()===this.el);)s.select(),this.doHighlight(!0),s.collapse(!1)}g(this.el).removeAllRanges(),n.scrollTo(i,o)},l.createWrapper=function(e){var t=document.createElement("span");return t.style.backgroundColor=e.color,t.className=e.highlightedClass,t},e.TextHighlighter=l}(window);