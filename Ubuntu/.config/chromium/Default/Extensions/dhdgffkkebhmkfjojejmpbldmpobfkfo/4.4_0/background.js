'use strict';var trup,init,lfgs,sycl,cfgo,uris,dast,perm,blak,scbr,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads tools storage uri compat parser layout helper syncinfo notify asker i18n native".split(" "),function(){var n=Registry.log,q=rea.FEATURES,ha=function(){var d=[],e=!0,f=function(d,f,c){var a={title:d.join("\n\n")};f.path=rea.extension.getURL("images/icon"+(f.frag?"_"+f.frag:"")+".png");n.warn(d.join("\n"));rea.browserAction.setIcon({path:f.path});rea.browserAction.setTitle(a);f=function(a,c,k){a={name:"1",sub_menu_item:!0,pos:"left",
items:[]};a.items.push({name:d[0],image:"info"});1<d.length&&a.items.push({name:d[1]});k({items:[a],options:{enabled:!1}})};c||rea.extension.onMessage.addListener(f)};return{run:function(){try{Registry.verify("5549").length&&(e=!1,f(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(d){e=!1,n.error(d.message)}if("chromeStorage"==q.DB.USE&&!q.DB.NO_WARNING){var A=
function(){if(!u)return window.setTimeout(A,2E3);u.isWorking().fail(function(){confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"http://tampermonkey.net/faq#Q206"},function(){});f(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(A,
1E3)}return e},pause:f,setWarning:function(f,e,c){d.push({text:f,description:e,url:c})},getWarnings:function(){return d}}}();if(ha.run()){var m=Registry.get("promise"),x=Registry.get("helper"),ta=Registry.get("tools"),L=Registry.get("statistics"),u=Registry.get("storage"),R=Registry.get("notify"),X=Registry.get("asker"),N=Registry.get("native"),Ba=Registry.get("permission"),ia=Registry.get("layout"),B=Registry.get("uri"),d=Registry.get("i18n"),H=Registry.get("downloads"),I=ta.cache;uris=B;down=H;
perm=Ba;dast=u;var ua=x.createUUID(),O={},Y={};n.debug("Starting background fred @"+ua);I.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();I.create("regexp").setOptions({timeout:3600,check_interval:120,retimeout_on_get:!0}).init();var Ca=function(){var d=m(),r,f,h=rea.extension.manifest.version,l=u.getSchemaVersion(),c=l;u.getVersion("0.0.0.0").then(function(a){f=a;r=D.versionCmp(h,f)==D.versionCmp.eNEWER;return u.isWiped()}).then(function(a){!r&&a&&(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!",
"You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","http://tampermonkey.net/faq.php#Q207"],n.warn(a.join("\n")),ha.setWarning.apply(this,a))}).always(function(){var a=[],b=0,g=function(){if(b<a.length){var k=a[b].schema;a[b].cond(k)?a[b].fn().done(function(){k&&(n.log("Converted database from",c,"to",k),c=k);b++;g()}).fail(function(){d.reject()}):(b++,g())}},k=function(){n.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
ha.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})},a=[{cond:function(){return r&&!q.RUNTIME.FIREFOX&&!q.RUNTIME.EDGE&&"chromeStorage"==q.DB.USE&&!u.getValue(q.CONSTANTS.STORAGE.LEGACY_VERSION)&&D.versionCmp("3.5.3603",f)==D.versionCmp.eNEWER},fn:function(){var a=m();rea.extension.inIncognitoContext?(k(),a.reject()):(n.log("Update database..."),c="3.5.3603",u.migrate("sql",
"chromeStorage").done(function(){n.log("Copied config for default usage of chrome storage");a.resolve()}));return a.promise()}},{cond:function(){return r&&D.versionCmp("3.6.3650",c)==D.versionCmp.eNEWER&&D.versionCmp("3.5.3650",f)==D.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{c="3.6.3650";var b=[];[{o:"TM_config",n:q.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:q.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var c=
u.getValue(a.o);void 0!==c&&b.push(u.setValue(a.n,c))}b.push(u.deleteValue(a.o))});var g=/@re$/,d=[];u.listValues().forEach(function(a){-1!=a.search(g)&&(a=a.replace(g,""),d.push(a))});d.forEach(function(a){var c=u.getValue(a+"@st"),g=u.getValue(a),k=u.getValue(a+"@re"),t=u.getValue(a+"@source"),d=z.getUidByName(a)||x.createUUID();b.push(u.deleteValue(a+"@st"));b.push(u.deleteValue(a));b.push(u.deleteValue(a+"@re"));b.push(u.deleteValue(a+"@source"));g&&k&&t?(b.push(u.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+
d,a)),b.push(u.setValue(q.CONSTANTS.PREFIX.COND+d,k)),b.push(u.setValue(q.CONSTANTS.PREFIX.STORE+d,c)),b.push(u.setValue(q.CONSTANTS.PREFIX.SCRIPT+d,t)),b.push(u.setValue(q.CONSTANTS.PREFIX.META+d,g))):n.warn("invalid script entry",{source:t,meta:g,cond:k})});g=/@st$/;u.listValues().forEach(function(a){-1!=a.search(g)&&b.push(u.deleteValue(a))});m.when(b).done(function(){n.log("Converted database from",f,"to",c);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return D.versionCmp(a,
c)==D.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{var b=[],c=new RegExp("^"+q.CONSTANTS.PREFIX.META);u.listValues().forEach(function(a){if(-1!=a.search(c)){var g=u.getValue(a);g.options&&g.options.override&&!g.options.override.orig_run_at&&(g.options.override.orig_run_at=g.options.run_at||"document-idle",g.options.run_at=null,b.push(u.setValue(a,g)))}});m.when(b).done(function(){a.resolve()})}return a.promise()}},{schema:"4526",cond:function(a){return r&&
q.RUNTIME.SAFARI&&"chromeStorage"==q.DB.USE&&D.versionCmp(a,c)==D.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{n.log("Update database...");var b=u.migrate("localStorage","chromeStorage").done(function(){n.log("Copied config for default usage of setting storage")});a.consume(b)}return a.promise()}},{schema:"4871",cond:function(a){return r&&D.versionCmp(a,c)==D.versionCmp.eNEWER},fn:function(){var a=m(),b,c,g=u.getValue(q.CONSTANTS.STORAGE.CONFIG);
g&&g.scriptTemplate&&(c=e.getDefaults())&&(b=c.script_templates)&&b[0]&&b[0].value&&(b[0].value=g.scriptTemplate,delete g.scriptTemplate,u.setValue(q.CONSTANTS.STORAGE.CONFIG,g));a.resolve();return a.promise()}},{schema:"5465",cond:function(a){return D.versionCmp(a,c)==D.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)k(),a.reject();else{var b=u.getValue(q.CONSTANTS.STORAGE.CONFIG);b&&1==b.sync_version&&(b.sync_enabled=!1,u.setValue(q.CONSTANTS.STORAGE.CONFIG,b));a.resolve()}return a.promise()}},
{cond:function(){return r||D.versionCmp(c,l)==D.versionCmp.eNEWER},fn:function(){var a=m();u.setVersion(h,c).done(function(){a.resolve()});return a.promise()}},{cond:function(){return r},fn:function(){n.log("First run of version "+h+"!");va.scheduleNotification(f,"0.0.0.0"==f);return m.Pledge()}},{cond:function(){return!0},fn:function(){var a=m();d.resolve();window.setTimeout(a.resolve,q.MISC.TIMEOUT);return a.promise()}}];g()});return d.promise()},da=function(){return{get:function(d,r){var f=(0==
d)+"#"+r,h=I.items.rundata.getj(f);if(h)h=h.oldret;else{var h=[],l=0,c={};if(r)for(var a=w.determineScriptsToRun(r,!0),b=0;b<a.length;b++){var g=a[b];g.enabled?g.evilness&&g.evilness>=e.values.script_blacklist_severity||0!=d&&(!0===g.options.noframes||null===g.options.noframes&&!0===g.options.override.orig_noframes)||w.isContexter(g)||(c[g.name]=!0,h.push(g)):l++}h={runners:h,disabled:l,script_map:c};r&&I.items.rundata.setj(f,{frameId:d,oldret:h})}return h},answer:function(d,r){var f=x.select(d,function(a){return a}),
h=[{m:"native",t:[H.staticVars.DEFAULT,H.staticVars.NATIVE]},{m:"disabled",t:[H.staticVars.OFF]},{m:"browser",t:[H.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(e.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",l=rea.extension.inIncognitoContext,c=!l&&"off"!=e.values.external_connect&&w.validUrl(r,wa.externally_connectable_reg);return{scripts:f,contexters:ka.getContexterCount(),raw:{},external_connect:c,inIncognitoContext:l,downloadMode:h,enforce_strict_mode:"on"==
e.values.runtime_strict_mode,statistics:L.isActive("api"),measure_scripts:e.values.debug,logLevel:e.values.logLevel,version:rea.extension.manifest.version}},getContexters:function(d,e){for(var f=[],h=w.determineScriptsToRun(e),l=0;l<h.length;l++){var c=h[l];c.enabled&&(0==d||!0!==c.options.noframes&&(null!==c.options.noframes||!0!==c.options.override.orig_noframes))&&w.isContexter(c)&&f.push(c)}return f}}}(),C=function(){var d={},r=1,f=r++,h=r++,l=r++,c=r++,a=r++,b=r++,g=r++,k=function(){var a={frames:{0:{state:f}},
tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},t={updateStats:function(a,b,c,g){d[a].stats.running+=c;d[a].stats.disabled+=g;d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a].stats.running-=c;d[a].stats.disabled-=g});d[a].tabs.ts=Date.now()},updateMaps:function(a,b,c){var g=1,
k=function(b,c){void 0===d[a].maps[c]&&1===g&&(d[a].maps[c]=0);d[a].maps[c]+=g};x.each(c,k);d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a]&&(g=-1,x.each(c,k))})},updateUrls:function(a,b,c){var g=function(g){1===g&&(void 0===d[a].urls[c]?d[a].urls[c]={frameId:b,count:0}:0===b&&(d[a].urls[c].frameId=b));d[a].urls[c].count+=g;d[a].urls.length=-1};g(1);d[a].contexts.onUnload[b]=d[a].contexts.onUnload[b]||[];d[a].contexts.onUnload[b].push(function(){d[a]&&
g(-1)})},determine:function(a,b,c){var g=null;T.isAllowed(c)?g=c:(n.debug("This URL is filtered by the security settings:",c,"-> Do nothing!"),C.set.forbidden(a,b));g=da.get(b,g);d[a].scripts[c]=g;g.runners.forEach(function(c){c.webRequest&&ea.scripts.set(a,b,c.uuid,c.webRequest)});return g.runners.length},run:function(a,b,c,g,k){a=[];for(b=0;b<g.length;b++)a.push(xa.bundle({url:c},g[b]));var d;m.when(a).always(function(a){k?k(a):d=a});return d}},v={},p={},y={},M={},E={listeners:{once:{whenReady:function(a,
b){if(!d[a]||d[a].frames[0].state<l)E.listeners.once.onReady(a,b);else b()},onReady:function(a,b){var c=function(a){E.listeners.remove.onCommited(g);E.listeners.remove.onCompleted(k);a&&b()},g=E.listeners.add.onCommited(function(b){b===a&&c(!0)}),k=E.listeners.add.onCompleted(function(b){b===a&&c(!0)})}},add:{onReset:function(a){var b=x.createUUID();v[b]=a;return b},onCommited:function(a){var b=x.createUUID();p[b]=a;return b},onCompleted:function(a){var b=x.createUUID();y[b]=a;return b},onRemoved:function(a){var b=
x.createUUID();M[b]=a;return b}},remove:function(){return{onReset:function(a){delete v[a]},onCommited:function(a){delete p[a]},onCompleted:function(a){delete y[a]},onRemoved:function(a){delete M[a]}}}()},events:{reset:function(a,b){var c;q.RUNTIME.FAST_EXEC_SUPPORT&&(c=d[a])&&Object.keys(c.frames).forEach(function(b){E.events.clean(a,b)});c=d[a]=k();c.frames[0].state=f;x.each(v,function(c){c&&c(a,b)})},response:function(a,b,c){if(e.values.enabled){var g=d[a]=d[a]||k(),p=g.frames[b]=g.frames[b]||{},
v=p.state||f;0===b&&(g.tabs.response_ts=Date.now());c=B.woHash(c);v<h&&(t.determine(a,b,c),p.state=h);return(a=g.scripts[c])?a.runners.length:0}},commited:function(a,b,c){if(e.values.enabled){var g=B.parse(c);if("http:"===g.protocol||"https:"===g.protocol||"file:"===g.protocol){var g=d[a]=d[a]||k(),g=g.frames[b]=g.frames[b]||{},v=g.state||f;v>=l||(g.state=l,v<h&&(c=B.woHash(c),t.determine(a,b,c)),x.each(p,function(b){b&&b(a)}))}}},loading:function(a,b,g){if(e.values.enabled){var p=B.parse(g);if(("http:"===
p.protocol||"https:"===p.protocol||"file:"===p.protocol)&&0===b&&"file:"===p.protocol){p=d[a]=d[a]||k();p.frames[b]=p.frames[b]||{};var v=p.frames[b].state||f;v>=c||(p.frames[b].state=c,v<h&&(g=B.woHash(g),t.determine(a,b,g)))}}},run:function(b,c,g,p,f){if(e.values.enabled){var v=0===c||q.RUNTIME.FAST_EXEC_SUPPORT?c:g,y=d[b]=d[b]||k();y.frames[v]=y.frames[v]||{};var h=B.woHash(p),M=y.scripts[h];if(!M&&(n.debug("tv: lazy init @ events.run("+b+", "+c+", "+g+", "+p+")"),t.determine(b,c,h),M=y.scripts[h],
!M)){n.warn("tv: no script run info for tab "+b+" @ "+h,n.D?y.scripts:"");return}g=y.frames[v].state;y.frames[v].state=a;g!=a&&(t.updateMaps(b,v,M.script_map),t.updateUrls(b,v,h),t.updateStats(b,v,M.runners.length,M.disabled));return t.run(b,c,h,M.runners,f?function(a){E.events.clean(b,v,p);f(a)}:null)}},clean:function(a,b,c){if(e.values.enabled){var g,k;if(g=d[a])c&&(c=B.woHash(c),delete g.scripts[c]),(k=C.get.objurl(a,b))&&URL.revokeObjectURL(k)}},complete:function(c,g,p){p=B.parse(p);if(e.values.enabled&&
("http:"===p.protocol||"https:"===p.protocol||"file:"===p.protocol)){if(0===g){var t=d[c]=d[c]||k();t.frames[g]=t.frames[g]||{};var v=t.frames[g].state||f;t.frames[g].state=b;if(!C.get.empty(c)&&C.get.stats(c).running){if(v<a){n.warn("tv: no script run info!");return}"file:"===p.protocol?window.setTimeout(function(){rea.tabs.sendMessage(c,{method:"onLoad",frameId:g},function(){})},500):rea.tabs.sendMessage(c,{method:"onLoad",frameId:g},function(){})}}x.each(y,function(a){a&&a(c)})}},unload:function(a,
b,c){c=0===b||q.RUNTIME.FAST_EXEC_SUPPORT?b:c;q.RUNTIME.FAST_EXEC_SUPPORT&&E.events.clean(a,b);a=d[a]=d[a]||k();a.frames[c]=a.frames[c]||{};a.frames[c].state=g;if(a.contexts.onUnload[c]){for(b=0;b<a.contexts.onUnload[c].length;b++)a.contexts.onUnload[c][b]();a.contexts.onUnload[c]=[]}},remove:function(a){var b;q.RUNTIME.FAST_EXEC_SUPPORT&&(b=d[a])&&Object.keys(b.frames).forEach(function(b){E.events.clean(a,b)});delete d[a];x.each(M,function(b){b&&b(a)})}},set:{extra:function(a,b,c,g){a=d[a]=d[a]||
k();null===b?a.extra[c]=g:(a.extra[c]=a.extra[c]||{},a.extra[c][b]=g)},objurl:function(a,b,c){E.set.extra(a,b,"objurl",c)},blocker:function(a){E.set.extra(a,null,"blocker",!0)},forbidden:function(a,b){0===b&&E.set.extra(a,null,"forbidden",!0)},requests:function(a,b,c,g){a=d[a]=d[a]||k();b=a.frames[b]=a.frames[b]||{};(b.requests=b.requests||{})[c]=g}},get:{extra:function(a,b,c,g,k){void 0===g&&(g=null);a=(d[a]?d[a].extra:{})[c];null!==b&&a&&k&&delete a[b];return a||g},empty:function(a){var b=!0;if(d[a]&&
0!=d[a].urls.length){if(-1==d[a].urls.length)return d[a].urls.length=0,x.each(d[a].urls,function(b,c){"length"!==c&&0<b.count&&d[a].urls.length++}),E.get.empty(a);b=!1}return b},urls:function(a){return d[a]?d[a].urls:{}},stats:function(a,b){var c={};if(d[a]&&(c.running=d[a].stats.running,c.disabled=d[a].stats.disabled,b)){c.unique=0;for(var g in d[a].maps)d[a].maps.hasOwnProperty(g)&&0<d[a].maps[g]&&c.unique++}return c},tabs:function(){var a={};x.each(d,function(b,c){a[c]={ts:b.response_ts}});return a},
objurl:function(a,b){return E.get.extra(a,b,"objurl",null,!0)},blocker:function(a){return E.get.extra(a,null,"blocker")},forbidden:function(a){return E.get.extra(a,null,"forbidden")},requests:function(a,b){return d[a]&&d[a].frames[b]?d[a].frames[b].requests:null}}};return E}(),oa=function(){return{isScriptUrl:function(d){if(!d||-1!=d.search(/\#bypass=true/)||-1!=d.search(q.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||"data:"===d.substr(0,5))return!1;d=d.split(/[\?#$]/)[0];var e=-1!=d.search(/.+\.user\.(js\#|js\?|js$)/)||
-1!=d.search(/.+\.tamper\.(js\#|js\?|js$)/);return e?!(-1!=d.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=d.search(/^htt[ps]{1,2}:\/\/(github|gitlab)\.com/)&&!w.determineOriginOfUrl(d)||-1!=d.search(/^htt[ps]{1,2}:\/\/bitbucket\.org/)&&!w.determineOriginOfUrl(d)):e}}}(),ya=function(){var d=function(d){var f=m(),h=Date.now();d.url+=-1!=d.url.search("\\?")?"&":"?";d.url+="ts="+h;var h=function(a){if(4==a.readyState&&(200==a.status||0==a.status))if("arraybuffer"==e.responseType){if(a.response){f.resolve({decoded:!0,
encoding:d.encoding,content:J.arrbuf2str(a.response,d.encoding)});return}}else if(null!==a.response&&void 0!==a.response){f.resolve({decoded:!0,encoding:d.encoding,content:a.response});return}f.reject({content:""})},e={method:"GET",retries:0,responseType:"arraybuffer",url:d.url};if(d.sync){var c=U(e,{});4==c.readyState&&0==c.status&&c.error&&(delete e.responseType,c=U(e,{}));h(c)}else U(e,{ondone:h});return f.promise()};return{getSource:function(e){"string"===typeof e&&(e={url:e});return d(e)}}}();
lfgs=ya;var T=function(){return{init:function(){var d=function(){I.items.regexp.remove("PageFilter")};e.addChangeListener("forbiddenPages",d);e.addChangeListener("page_whitelist",d);e.addChangeListener("page_filter_mode",d)},isAllowed:function(d){var r=!1,f=!1,h=0!=e.values.forbiddenPages.length,l=0!=e.values.page_whitelist.length;switch(e.values.page_filter_mode){case "black":f=h;break;case "off":break;case "white":r=l;break;default:r=l,f=h}(h=I.items.regexp.get("PageFilter"))||(h=w.regexify({inc:r?
e.values.page_whitelist:void 0,exc:f?e.values.forbiddenPages:void 0}),I.items.regexp.set("PageFilter",h));return!f&&!r||w.validUrl(d,h)}}}(),S=function(){var A=function(d,h){var e=!1;if(h.length)return(e="/"==h.substr(0,1)?w.matchUrl(d,w.convertToRegExp(h)):-1!=d.search(h))&&n.debug('black: entry "'+h+'" matched'),e},r={init:function(){var d=m(),h=function(){"server"===e.values.script_blacklist_type&&window.setTimeout(r.checkUpdate,2E4)};h();e.addChangeListener("script_blacklist_type",h);d.resolve();
return d.promise()},getWarningsFor:function(f){var h=[];f&&x.each(e.values.script_blacklist_server,function(e){if(e){var c;x.each(e.rules,function(a){c|=A(f,a);return 1!=c});if(c)if(e.reasons){var a=Object.keys(e.reasons),b,g;void 0!==(b=d.getBestLocale(a))&&(g=a[b]);h.push(e.reasons[g||"en"])}else e.reason&&h.push(e.reason)}});return h},getEvilnessOf:function(d){if("off"===e.values.script_blacklist_type)return!1;if(!d)return 0;var h=!1,l=0;x.each(e.values.require_blacklist,function(c){h|=A(d,c);
return 1!=h});h?l=11:"server"===e.values.script_blacklist_type&&x.each(e.values.script_blacklist_server,function(c){if(c&&(x.each(c.rules,function(a){h|=A(d,a);return 1!=h}),h))return l=c.severity,!1});return Number(l)},checkUpdate:function(d){var h=m(),A=Z.getConfig(),c;if(d||6048E5<Date.now()-A.black.last){var a=function(a,c){var d=m();U({method:"GET",url:a,nocache:c,retries:q.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){d.resolve(a)}});return d.promise()};
a("https://blacklist.tampermonkey.net/get.php?version=get").then(function(b){if(4==b.readyState&&200==b.status){try{c=JSON.parse(b.responseText).version}catch(g){n.warn("black: unable to parse version response! "+b.responseText)}n.info("black: local version: "+A.black.version+" remote: "+c);if(c>A.black.version||d)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(function(a){if(a&&4==a.readyState&&200==a.status)try{var c=JSON.parse(a.responseText);c&&c.blacklist&&1==c.version&&(e.values.script_blacklist_server=
c.blacklist);n.info("black: updated blacklist to ",c)}catch(d){n.warn("black: blacklist update failed! ",a.responseText)}}).always(function(){A=Z.getConfig();A.black.last=Date.now();A.black.version=c||A.black.version;Z.setConfig(A);h.resolve()})}else h.resolve();return h.promise()}};return r}();blak=S;var Da=function(){for(var d=[],e=[],f=0;f<d.length;f++){var h=Registry.getRaw("system/"+d[f]+".tamper.js");h&&e.push(h)}return e},K=function(){var A=0,r=[],f={to:null,force:null,t:0},h={},l=ta.createQueue(1),
c=function(a){return l.add(function(){n.debug("sync: import",a.uuid,a.name,a.url);var b={imported:e.values.sync_type},c={},g;for(g in p.SYNCED)!0===p.SYNCED[g]&&(c[g]=a.options[g]);var d={uuid:a.uuid,ask:!1,internal:!0,sync:b,force_meta:{lastModified:a.lastModified,fileURL:a.url},force_options:c},k={silent_fail:!0};return G.caps.syncsSource?G.getSource(a.uuid).then(function(a){return w.installFromSource(a,d,k)}):w.installFromUrl(a.url,d,k)})},a=function(a,b){return l.add(function(){if(!G.caps.syncsSource){var c;
if(!a.url||!(c=B.parse(a.url))||!c.protocol.match(/https?:/))return n.debug("sync: skip export due to missing URL",a.name,a.url),m.Pledge(!1)}n.debug("sync: export",a.name,a.url);return G.setMeta(a,{lastModified:a.lastModified}).then(function(){if(G.setSource&&b)return G.setSource(a.uuid,b)}).then(function(){return!0})})},b=function(a){var b=a.downloadURL?a.downloadURL.split("#")[0]:null,c=a.fileURL?a.fileURL.split("#")[0]:null,g=x.select([c,b],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0],
b={uuid:a.uuid,name:a.name,options:{},durl:b,furl:c,url:g,lastModified:a.lastModified||a.lastUpdated},d;for(d in p.SYNCED)!0===p.SYNCED[d]&&null!==a.options[d]&&(b.options[d]=a.options[d]);return b},g=function(){var a=[];z.getUidList().forEach(function(c){c=z.getByUid(c);if(c.script&&c.cond){var g=b(c.script);g.lastModified||Registry.isDevVersion("test")?a.push(g):n.warn("sync: script without updated/modified timestamps found",c.script)}});return a},k=function(b){if(p.enabled)if(0<A)b&&p.addSyncDoneCallback(function(a){a&&
p.sync(50,b)});else{A++;var k=null,t=null,v=!1,f=!0,l=function(a){if(a)for(var b=0;b<t.length;b++)if(t[b].uuid==a)return t[b];return null},q=function(a){if(!a)return null;for(var b=0;b<k.length;b++)if(k[b].uuid==a)return k[b]};return m.Pledge().then(function(){k=g();return G.list().done(function(a){t=a}).fail(function(){n.warn("sync: unable to get remotelist!")})}).then(function(){var a=t.map(function(a){var b=q(a.uuid),g,k;if(b){if(!a.lastModified&&e.values.sync_type==G.types.eCHROMESYNC)for(var t in p.SYNCED)if(!0===
p.SYNCED[t]&&b.options[t]!=a.options[t]){n.debug("sync: importable change detected!",a.name,"key:",t,a);g=!0;break}a.lastModified&&a.lastModified>b.lastModified&&(k=a.lastModified,g=!0,n.debug("sync: importable change detected!",a.name,"local ts:",new Date(b.lastModified),"remote ts:",new Date(a.lastModified),a))}if(!b||g)return function(){return m.Pledge().then(function(){return G.caps.specialMeta?G.getMeta(a.uuid):m.Pledge(a)}).then(function(a){if(a){var t;if(b)if(a.options.removed)v=!0,n.debug("sync: remove local script",
a.uuid,a.name,a.url),w.doRemove(b.uuid,!1);else{if(g){k!=a.lastModified&&(a.lastModified&&n.warn("sync: list and meta data lastModified differ, this will cause extra traffic!","file ts:",new Date(k),"meta ts:",new Date(a.lastModified),a),a.lastModified=k);v=!0;n.debug("sync: update local script",a.uuid,a.name,a.url);var f=z.getByUid(b.uuid);if(f.script&&f.cond){for(t in p.SYNCED)!0===p.SYNCED[t]&&(f.script.options[t]=a.options[t]);f.script.lastModified=a.lastModified;return m.Pledge().then(function(){if(G.caps.syncsSource)return G.getSource(a.uuid,
f.script.textContent).done(function(a){f.script.textContent=a})}).then(function(){return w.doModify(f.script.uuid,f.script,!1)})}n.warn(d.getMessage("fatal_error")+"("+b.name+")!!!")}}else if(!b&&!a.options.removed)if(t=m(),a.url&&h[a.url]||a.uuid&&h[a.uuid])n.warn("sync: skip previously failed import",a);else return c(a).done(function(b){b?v=!0:(n.warn("sync: unable to import",a),h[a.url]=!0,h[a.uuid]=!0)}).fail(function(){n.warn("sync: unable to load",a);h[a.url]=!0;h[a.uuid]=!0}).always(t.resolve),
t.promise()}})}}).filter(function(a){return a});return m.onebyone(a)}).then(function(){v&&w.reorderScripts();k=g();return m.Pledge()}).then(function(){for(var b=[],c=0;c<k.length;c++)b.push(function(){var b=k[c],g,d;if(!G.caps.syncsSource&&!b.url)return m.Pledge();var p=l(b.uuid);if(p){if(!p.lastModified||b.lastModified>p.lastModified)g=!0,n.debug("sync: exportable change detected!",b.name,"remote ts:",new Date(p.lastModified),"local ts:",new Date(b.lastModified),b)}else n.debug("sync: export because remotely missing!",
b.name,"local ts:",new Date(b.lastModified),b);return!p||g?(G.caps.syncsSource&&(g=z.getByUid(b.uuid),g.script&&g.cond&&(d=g.script.textContent)),a(b,d).then(function(a){a&&(v=!0)})):m.Pledge()}());return m.when(b)}).fail(function(){f=!1}).done(function(){f=!0}).always(function(){n.debug("sync: finished");if(0==--A)for(var a=f;r.length;)r.shift()(a)})}},t=function(){p.enabled&&p.sync(500,!0)},v=null,p={enabled:!1,SYNCED:{comment:!0},configChangeListener:function(){v||(v=window.setTimeout(function(){v=
null;p.init().done(function(){p.enabled&&p.sync(3E3)})},3E3))},init:function(){var a=m();p.enabled=!1;(function(){return e.values.sync_enabled&&e.values.sync_type?G.init(e.values.sync_type).done(function(a){p.enabled=a;p.enabled?G.addChangeListener(t):n.warn("sync: init failed!")}).fail(function(){n.warn("sync: init failed!")}):m.Pledge()})().always(function(){a.resolve(p.enabled)});return a.promise()},finalize:function(){},reset:function(){return p.enabled?G.reset():m.Breach()},addSyncDoneCallback:function(a){r.push(a)},
sync:function(a,b){var c=Date.now();a=a||500;b=f.force||b;f.to?(window.clearTimeout(f.to),f.ts<c+a&&(a=f.ts-c,1>a&&(a=1))):n.debug("sync: schedule sync for run in "+a+" ms");f.force=b;f.ts=c+a;f.to=window.setTimeout(function(){k(f.force);f.to=null;f.force=null},a)},scriptAddedCb:function(c,g){if(p.enabled){var d=b(g);a(d,g.textContent)}},scriptChangedCb:function(){p.enabled&&p.sync(6E4)},scriptRemovedCb:function(a,c){if(p.enabled){var g=b(c);n.debug("sync: remove",g.name,g.url);G.remove(g)}}};return p}();
sycl=K;var Ea=function(){e.addChangeListener("sync_enabled",K.configChangeListener);e.addChangeListener("sync_type",K.configChangeListener);e.addChangeListener("logLevel",function(){n.set(e.values.logLevel)});e.addChangeListener("i18n",function(){d.setLocale(e.values.i18n)});e.addChangeListener("native_import_path",function(){N.setPath(e.values.native_import_path)});e.addChangeListener("incognito_mode",function(){za()});e.addChangeListener("statistics_enabled",function(){L.setEnabled(e.values.statistics_enabled)});
e.addChangeListener("require_blacklist",w.blackCheckAll);e.addChangeListener("script_blacklist_server",w.blackCheckAll);e.addChangeListener("script_blacklist_type",w.blackCheckAll);e.addChangeListener("downloads_extension_whitelist",H.config_changed_listener);e.addChangeListener("downloads_mode",H.config_changed_listener);e.addChangeListener("webrequest_modHeaders",function(d,e,f,h){h.done(window.setTimeout(V.reset,1))})},e=function(){var d={},e={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,
webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},{name:"ECMAScript 6",
value:'// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.18.2/babel.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.16.0/polyfill.js\n// @match        <$URL$>\n// ==/UserScript==\n\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n/* jshint ignore:end */\n    /* jshint esnext: false */\n    /* jshint esversion: 6 */\n\n    // Your code here...\n\n/* jshint ignore:start */\n]]\x3e</>).toString();\nvar c = Babel.transform(inline_src, { presets: [ "es2015", "es2016" ] });\neval(c.code);\n/* jshint ignore:end */'},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/extras/coffee-script.js\n// @match        <$URL$>\n// ==/UserScript==\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n\n    // Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);\n/* jshint ignore:end */"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",runtime_strict_mode:"byscript",runtime_inject_mode:"default",autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_fontSize:100,editor_theme:"default",editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:"spaces",editor_tabMode:"indent",editor_electricChars:!0,editor_autoSave:!1,editor_easySave:!0,
editor_autoLint:!0,editor_autoLintMaxLen:5E4,editor_lineWrapping:!1,editor_highlightTrailingWhitespace:!0,editor_trimTrailingSpacesFromModifiedLines:!0,favicon_service:"google",native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:2<=q.ACTIONMENU.COLUMNS?2:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"position",incognito_mode:"temporary",layout:"default",layout_user_css:"",sync_enabled:!1,sync_type:2,statistics_enabled:!0,downloads_mode:"default",
downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),external_update_interval:6048E5,external_connect:"all",require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/",
"http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},f=function(c){var a=u.getValue(q.CONSTANTS.STORAGE.CONFIG,{});return void 0===a[c]?e[c]:a[c]},h=function(c,a){var b=u.getValue(q.CONSTANTS.STORAGE.CONFIG,{}),g=void 0===b[c]?e[c]:b[c];b[c]=a;var k=u.setValue(q.CONSTANTS.STORAGE.CONFIG,
b);d[c]&&JSON.stringify(g)!=JSON.stringify(a)&&d[c].forEach(function(b){try{b(c,g,a,k)}catch(d){n.warn("config: changeListener error",d)}});return k},l={init:function(){var c=m();l.values={};l.__defineGetter__("snapshot",function(){return x.assign({},l.values)});for(var a in e)e.hasOwnProperty(a)&&function(){var b=a;l.values.__defineGetter__(b,function(){return f(b)});l.values.__defineSetter__(b,function(a){h(b,a)})}();l.initialized=!0;var b=Da();Object.keys(b).forEach(function(a){var c=b[a];window.setTimeout(function(){w.doSave({url:null,
src:c,ask:!1,replace:!0,internal:!0})},1)});c.resolve();return c.promise()},getValue:f,setValue:h,getDefaults:function(){return e},addChangeListener:function(c,a){d[c]||(d[c]=[]);d[c].push(a)}};return l}(),U=function(d,e){return la(d,e,{internal:!0})},ma=function(){var d=m();rea.tabs.getSelected(null,function(e){d.resolve(e)});return d.promise()},fa=function(){var d={},r=function(a){var b=a.split(".");if(3>b.length||B.isIp(a))return a;a=B.isSecondLevelDomain(b.slice(-2).join("."))?-3:-2;return b.slice(a).join(".")},
f=function(a){return a&&-1!=a.indexOf("*")},h=function(a){var b=m();T.isAllowed(a)?b.resolve({allowed:!0}):b.resolve({allowed:!1});return b.promise()},l=function(a,b){var c=function(a){return a?a.map(function(a){if(a.match(/^'?self'?$/))a=B.parse(b.url).hostname||null;else if("'none'"==a)a="none";else if(-1===["none","localhost","*"].indexOf(a)&&(1>a.indexOf(".")||1===(a.match(/\./g)||[]).length&&B.isSecondLevelDomain(a)))return null;return a}):[]};return{connects:a.options.override.merge_connects&&
"paranoid"!=e.values.connect_mode?c(a.connects):[],userconnects:c(a.options.override.use_connects),blockers:c(a.options.override.use_blockers)}},c=function(a,b,c){var g=m(),k=function(){g.resolve({permitted:!0})},t=function(a){g.resolve({permitted:!1,reason:a})},h=function(){g.resolve({unknown:!0})},l,r=function(a,b){var c=null,g=B.isIp(a);b.every(function(b){if(b.a)for(var d=0;d<b.a.length;d++)if(b.a[d]&&(g?b.a[d]===a:-1!=a.search(new RegExp("(^|.+\\.)"+x.escapeForRegExp(b.a[d])+"$"))))return c=
b.blocker?t:k,!1;return!0});return c};if("off"==e.values.connect_mode)k();else if((l=B.parse(c))&&l.hostname)if((c=r(l.hostname,[{a:d[a.uuid]}]))||(c=f(d[a.uuid])?k:null))c();else if(0===b.connects.length&&0===b.userconnects.length&&0===b.blockers.length)"casual"==e.values.connect_mode?k():"strict"==e.values.connect_mode?t("No @connects given, but strict mode enabled"):h();else if(-1!=b.connects.indexOf("none"))t("None value found");else{if("casual"!=e.values.connect_mode||f(b.blockers)||!(c=f(b.connects)?
k:null))(c=f(b.userconnects)?k:null)||(c=r(l.hostname,[{a:b.blockers,blocker:!0},{a:b.connects},{a:b.userconnects}])||h);c()}else t("URL can not be parsed");return g.promise()},a=function(){var a=function(a){for(var b=0;b<g.length;b++)if(g[b].tabId===a)return g.splice(b,1)[0];return g.pop()},c;ma().then(function(g){for(;!b&&(c=a(g.id));)c.fn()})},b,g=[],k=function(c,k,t,e,h){var l,q=m(),ja=function(){q.resolve({approved:!0})},u=function(){q.resolve({forbidden:!0})};n.debug('cor: "'+c.name+'" is asking for permission to access',
e,k);if((l=B.parse(e))&&l.hostname){var x=r(l.hostname),z=k.tab?k.tab.id:null;b=!0;ma().then(function(a){return X.askForConnect({src_url:k.url,hostname:l.hostname,domain:x,all_domains:f(t.connects),tabid:z,active:z===a.id,timeout:h,url:e,settings_url:rea.extension.getURL("options.html")+"#nav="+c.uuid+"+settings",connect_url:"http://tampermonkey.net/documentation.php#_connect",script:{name:c.name,uuid:c.uuid,icon:c.icon64||c.icon||rea.extension.getURL("images/txt.png")}})}).done(function(a){var b,
g=a.whole_domain?x:l.hostname;a.allow?a.once?(n.debug('cor: allowing "'+c.name+'" to access',g,"once"),ja()):a.temporary?(n.debug('cor: allowing "'+c.name+'" to access',g,"temporarily"),void 0===d[c.uuid]&&(d[c.uuid]=[]),-1==d[c.uuid].indexOf(g)&&d[c.uuid].push(g),ja()):(b=ja,a.all_domains?(n.debug('cor: allowing "'+c.name+'" to access all domains always'),c.options.override.use_connects.push("*")):(n.debug('cor: allowing "'+c.name+'" to access',g,"always"),c.options.override.use_connects.push(g),
b=ja)):a.once||a.aborted?(n.debug('cor: denying "'+c.name+'" to access',g,"once"),u()):(c.options.override.use_blockers||(c.options.override.use_blockers=[]),b=u,a.all_domains?(n.debug('cor: denying "'+c.name+'" to access any domains (additional) domain'),c.options.override.use_blockers.push("*")):(n.debug('cor: denying "'+c.name+'" to access',g,"always"),c.options.override.use_blockers.push(g)));b&&w.doModify(c.uuid,c,!1).always(b)}).fail(u).always(function(){b=!1;g.length&&window.setTimeout(a,1)})}else u();
return q.promise()},t=function(a,d,y,A){var E=l(a,d),r=arguments;return h(y).then(function(b){if(!0!==b.allowed)return m.Breach("URL is blacklisted");var g,k;return(g=B.parse(y))&&g.origin&&(k=B.parse(d.url))&&k.origin&&g.origin===k.origin?m.Pledge({permitted:!0}):c(a,E,y)}).then(function(c){if(!1===c.permitted)return m.Breach("URL is not permitted"+(c.reason?": "+c.reason:""));if(!0===c.permitted)return m.Pledge();if(0===E.connects.length||f(E.connects)){if(-1==["ask","paranoid"].indexOf(e.values.connect_mode))return m.Breach();
if(f(E.blockers))return m.Breach("URL was permanently blocked by the user");if(b){n.debug('cor: queuing access permission check from "'+a.name+'" to',y,d);var h=m();g.push({tabId:d.tab?d.tab.id:null,fn:function(){h.consume(t.apply(this,r))}});return h.promise()}return k(a,d,E,y,A).then(function(a){return!0===a.approved?m.Pledge():m.Breach("Request was blocked by the user")})}return m.Breach("URL is not a part of the @connect list")})};return{getSessionConnects:function(a){return d[a]||[]},setSessionConnects:function(a,
b){d[a]=b||[]},purgeAppeals:function(a){g=g.filter(function(b){return b.tabId!==a})},exec:function(a,b,c,g){var d,k,f,h,e=a.url,l=[],A=Math.max(Math.min(a.timeout||0,6E4),2E4),r=function(){for(var a;!f&&!h&&(a=l.shift());)a()},m=function(b,c){var d='Refused to connect to "'+(c||a.url)+'": '+(b||"Blocked by @connect CORS check"),k=pa.makeErrorResponse(d);["onerror","ondone"].forEach(function(a){if(g[a])g[a]({response:k,exception:d})})};if(!(c&&c.url&&c.tab&&a.url&&b&&(k=z.getByUid(b))&&k.script&&k.cond))return m();
t(k.script,c,a.url,A).done(function(){var b={};Object.keys(g).forEach(function(a){b[a]=function(p){var v=arguments;f||(h?l.push(function(){b[a].apply(this,v)}):function(){return p&&p.finalUrl&&e!==p.finalUrl?(h=!0,t(k.script,c,p.finalUrl,A).fail(function(){f||(d&&d.abort(),f=!0,m("Request was redirected to a not whitelisted URL",p.finalUrl),n.warn("cor: request to",e,"was redirect to a not whitelisted URL",p.finalUrl))}).always(function(){e=p.finalUrl;h=!1;l.length&&window.setTimeout(r,1)})):{always:function(a){a()}}}().always(function(){if(!f)g[a]({response:p})}))}});
d=la(a,b)}).fail(function(a){m(a);n.warn("cor: access to",e,"was denied")});return{abort:function(){f=!0;d&&d.abort()}}}}}(),qa=function(){var d=function(a){var b=[];a=new DataView(a);for(var c=0;c<a.byteLength;c+=4){var d=("00000000"+a.getUint32(c).toString(16)).slice(-8);b.push(d)}return b.join("")},e={md5:function(a,b){return m.Pledge(J.MD5(a,b))}},f={};["SHA-1","SHA-256","SHA-384","SHA-512"].forEach(function(a){var b=a.toLowerCase().replace("-","");f[b]=function(){var b=function(b,c){var g=m();
window.crypto.subtle.digest(a,J.str2arrbuf(b,c)).then(function(a){g.resolve(d(a))},function(){g.reject()});return g.promise()};try{return b("").then(function(a){if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return b})}catch(c){return m.Breach()}}});var h=function(a){return-1!=Object.keys(e).indexOf(a)},l=function(a){return function(){if(!1!==c){var b=arguments,g=m();c.push(function(){g.consume(a.apply(this,b))});return g.promise()}return a.apply(this,arguments)}},c=[];return{init:function(){n.D&&
Object.keys(e).forEach(function(a){n.debug("sri:",a,"is supported")});return m.sidebyside(Object.keys(f).map(function(a){return f[a]().done(function(b){n.debug("sri:",a,"is supported");e[a]=b}).fail(function(){n.debug("sri:",a,"is unsupported")})})).always(function(){c.forEach(function(a){a()});c=!1})},isSupported:l(function(a){return m.Pledge(h(a))}),getHash:l(function(a,b){var c=m();"string"===typeof a&&(a=B.parse(a));if(a&&a.hash){for(var k,t,f=a.hash.replace(/^#/,"").split(/,|;/g),p=0;p<f.length;p++)if((t=
f[p].match(/([^=|:|-]+)[=|:|-](.+)/))&&3==t.length&&h(t[1])){k=t[2];if(!/^[0-9a-fA-F]+$/.exec(k)){var e;var l=decodeURIComponent(k);try{e=d(J.str2arrbuf(J.Base64.decode(l)))}catch(E){e=null}k=e||k}k={type:t[1],value:k}}c.resolve(k||(b?k:{type:"unsupported",value:""}))}else c.resolve();return c.promise()}),check:l(function(a,b,c){return b&&a&&h(a.type)?e[a.type](b,c).then(function(b,c){return((c=b===a.value)?m.Pledge:m.Breach)(c||{type:a.type,value:b})}):m.Breach()})}}(),P=function(){var d={key:function(a,
b){return q.CONSTANTS.PREFIX.EXTERNAL+x.select([a,b?J.MD5(b):null],function(a){return a}).join(":")},list:function(a){var b=new RegExp("^"+a);return x.select(u.listValues(),function(a){return-1!=a.search(b)})},set:function(a,b,c){a=d.key(a,b);var k={};x.each(c,function(a,b){"content"==b&&(b="base",a=J.encodeS(a));k[b]=a});u.setValue(a,{ts:Date.now(),url:b,resource:k})},get:function(a,b){var c=d.key(a,b),c=u.getValue(c),k;if(c&&c.resource){var t={};x.each(c.resource,function(a,b){"base"==b&&(b="content",
a=J.decodeS(a));t[b]=a});k={ts:c.ts,url:c.url,data:t}}return k},clean:function(a,b){var c=d.key(a,b);u.deleteValue(c)},cleanAll:function(a,b){var c,k=d.list(d.key(a));if(b){var t={};x.each(b,function(b){b=d.key(a,b);t[b]=!0});c=[];x.each(k,function(a){t[a]||c.push(a)})}else c=k;c.forEach(function(a){u.deleteValue(a)})}},r=function(a,b){var c=m(),d={method:"GET",url:a,retries:q.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:b.via_arraybuffer?"arraybuffer":void 0},t=function(d){var k={content:""};if(4!=
d.readyState||200!=d.status&&0!=d.status||d.error)c.reject(k);else{for(var t,f=d.responseHeaders?d.responseHeaders.split("\n"):[],e,h=0;h<f.length;h++){var v=f[h].split(":"),l=v.shift()||"",v=v.join(":")||"";if("content-type"==l.trim().toLowerCase()&&(e=v.match("(image/|text/)([.-a-zA-Z0-9]+)"))){t=e[0];break}}t||(a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?t="image/x-icon":(e=a.match(".*.(gif|png)+($|\\?|#).*"))?t="image/"+e[1]:-1!=a.search(".*.(js)+($|\\?|#).*")?t="text/javascript":(e=a.match(".*.(css|html|xml)+($|\\?|#).*"))?
t="text/"+e[1]:x.isLocalImage(a)&&(t="image/x-icon"));k.meta=t;k.content=b.via_arraybuffer?J.arrbuf2str(d.response,b.encoding):d.responseText;c.resolve(k)}},f=function(){c.reject({})};b.sync?t(U(d,{})):(d.timeout=e.values.require_timeout,U(d,{onload:t,onerror:f,ontimeout:f}));return c.promise()},f=x.getDebouncer(9E3),h=function(a,b,c){c.no_storage=!0;l(a,b,c).done(function(c){d.set(a,b,c.resource)}).fail(function(c){n.warn("externals: update.failed :(",a,b,c)}).always(function(){var c=d.get(a,b);
c&&c.data?d.set(a,b,c.data):n.warn("externals: should never happen!")})},l=function(a,b,c){var k=m(),t=B.parse(b),v={sync:c.sync},p;qa.getHash(t,"supported"==e.values.require_sri_mode).done(function(y){if(b)if(S.getEvilnessOf(b)>=e.values.script_blacklist_severity)v.resource={blacklisted:!0,content:""},k.reject(v);else if("enforce"!=e.values.require_sri_mode||y)if(!c.no_storage&&"file:"!==t.protocol&&(p=d.get(a,b))){var l=d.key(a,b),E=Date.now();0<e.values.external_update_interval&&E-p.ts>e.values.external_update_interval&&
!f.is(l)&&(1<e.values.external_update_interval&&f.add(l),n.debug("externals: resource needs update",b,(new Date(p.ts)).toISOString(),(new Date(E)).toISOString()),window.setTimeout(function(){h(a,b,c)},3E3));v.resource=p.data;v.resource.forbidden||v.resource.blacklisted?k.reject(v):k.resolve(v)}else v.sync=!1,"file:"==t.protocol&&-1==b.search(q.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))?(q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("externals: Access to local files is forbidden! Loading the following @resource may fail:",
b,"-> more info:","http://tampermonkey.net/faq.php#Q204"),l=ya.getSource({url:b,encoding:c.encoding})):l=r(b,{via_arraybuffer:c.via_arraybuffer,encoding:c.encoding}),l.done(function(f){y&&(f.sri=y);var h=function(k){!c.no_storage&&t.protocol&&"file:"!==t.protocol&&-1==b.search(q.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))&&d.set(a,b,k)};y&&-1!=["supported","given"].indexOf(e.values.require_sri_mode)?qa.check(y,f.content,c.encoding).done(function(){v.resource=f;h(v.resource);k.resolve(v)}).fail(function(a){v.resource=
{forbidden:!0,sri:{mode:e.values.require_sri_mode,type:y.type,value:"invalid"},determined:a,content:""};h(v.resource);k.reject(v)}):(v.resource=f,h(v.resource),k.resolve(v))}).fail(function(c){n.debug("externals: get.failed",a,b,c);v.resource={failed:!0,content:""};k.reject(v)});else v.resource={forbidden:!0,sri:{mode:e.values.require_sri_mode},content:""},k.reject(v);else v.resource={forbidden:!0,content:""},k.reject(v)});return k.promise()},c={getElement:function(a,b){return d.get(a,b)},cleanElement:function(a,
b){return d.clean(a,b)},dropAll:function(a){d.cleanAll(a);return m.Pledge()},dropAllBut:function(a,b){d.cleanAll(a,b);return m.Pledge()},loadResources:function(a,b){var g=m();c.getResources(a,b).always(function(){g.resolve()});return g.promise()},loadRequires:function(a,b){var g=m();c.getRequires(a,b).always(function(){g.resolve()});return g.promise()},getResources:function(a,b){var c={elements:[]},d=m(),t=[],f={via_arraybuffer:!0,sync:!0};b.forEach(function(b){var d=b.url||B.sanitize(b.unsafe_url,
b.abs_url),k={name:b.name,url:d},d=l(a,d,f),e=m();d.done(function(a){a=a.resource;k.content=a.content;k.meta=a.meta||"application"}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url,"due to a SRI error"):n.warn("externals: can't load @resource",b.name,"from forbidden URL",b.unsafe_url):a.resource&&a.resource.blacklisted?n.warn("externals: can't load @resource",b.name,"from blacklisted URL",b.unsafe_url):(n.warn("externals: can't load @resource",
b.name,"from URL",b.unsafe_url),k.failed=!0);k.content=null}).always(function(a){f.sync&=a.sync;c.elements.push(k);e.resolve()});t.push(e)});m.when(t).always(function(){c.sync=f.sync;d.resolve(c)});return d.promise()},getRequires:function(a,b){var c={elements:[]},d=m(),f=[],e={encoding:"UTF-8",sync:!0};x.each(b,function(b,d){var k=b.url||B.sanitize(b.unsafe_url,b.abs_url),h={},k=l(a,k,e),r=m();k.done(function(a){h.textContent=a.resource.content||""}).fail(function(a){a=a.resource&&a.resource.forbidden?
a.resource.sri?"couldn't load @require from URL "+b.unsafe_url+" due to a SRI error":"couldn't load @require from forbidden URL "+b.unsafe_url:a.resource&&a.resource.blacklisted?"couldn't load @require from blacklisted URL "+b.unsafe_url:"couldn't load @require from URL "+b.unsafe_url;h.textContent='console.warn("Tampermonkey: " + decodeURIComponent("'+encodeURIComponent(a)+'"));\n';n.warn("externals: "+a)}).always(function(a){e.sync&=a.sync;c.elements[d]=h;r.resolve()});f.push(r)});m.when(f).always(function(){c.sync=
e.sync;c.elements=c.elements.filter(function(a){return a});d.resolve(c)});return d.promise()}};return c}();exts=P;var xa=function(){var d=function(d,h,l){var c=m(),a=[];l.forEach(function(b){b=b.textContent||"";b=na.mkCompat(b,d.options.compatopts_for_requires?d:null,"off"!=e.values.runtime_strict_mode);a.push(b)});l="\n"+a.join("\n")+"\n";var b=z.getStorageByUid(d.uuid);h=na.mkCompat(h,d,"off"!=e.values.runtime_strict_mode);if(e.values.debug){h=h.split("\n");for(var g=!1,k,t=0;t<h.length;t++)if(k=
h[t],!k.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(k.match(/^\s*\/\*/)&&(g=!0),g)if(k.match(/\*\/\s*$/))g=!1;else{if(-1!=(k=k.search(/\*\//))){h[t]=x.insert(h[t],k+2,0,"debugger;");break}}else{h[t]="debugger;"+h[t];break}h=h.join("\n")}c.resolve({header:d.header,code:h,requires:l,storage:b,script:d});return c.promise()},r={};return{bundle:function(f,e){var l,c,a=!0;if(l=r[e.uuid])return l;var b={},g="includes matches requires resources excludes connects textContent".split(" ");
Object.keys(e).forEach(function(a){-1==g.indexOf(a)&&("options"==a?(b[a]=JSON.parse(JSON.stringify(e[a])),b[a].run_at=b[a].run_at||e.options.override.orig_run_at||"document-idle"):b[a]=e[a])});l=P.getResources(b.uuid,e.resources).then(function(c){a&&!c.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=c.sync);b.resources=c.elements;return P.getRequires(b.uuid,e.requires)}).then(function(c){a&&!c.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),
a=c.sync);c=c.elements;n.debug("run script "+b.name+" @ "+f.url);return d(b,e.textContent,c)}).always(function(){c=!0;delete r[b.uuid]});c||(r[b.uuid]=l);return l}}}(),Aa=function(){var d=rea.extension.getViews({type:"popup"});d&&d.length&&rea.extension.sendMessage({method:"updateActions"},function(){})},Z=function(){return{getConfig:function(){var d={version:0,last:0},e={scripts:0},f=u.getValue(q.CONSTANTS.STORAGE.UPDATE,e);"object"!==typeof f&&(f=e);f||(f=e);void 0==f.black&&(f.black=d);void 0==
f.scripts&&(f.scripts=0);return f},setConfig:function(d){d&&u.setValue(q.CONSTANTS.STORAGE.UPDATE,d)}}}(),aa=function(){var A=function(h,l){var c=0,a=0;if(h){var b=d.getMessage("Script_Update"),g=d.getMessage("Check_for_userscripts_updates")+"...";R.show(b,g,rea.extension.getURL("images/icon128.png"),1E4)}b=z.getUidList().map(function(b){var g,h,p,y,r,E;n.info("update: check for script updates @",b);return function(){y=z.getByUid(b);if(!y.script||!y.cond)return n.warn("update: inconsistent script entry",
b,y),m.Breach();var a=!e.values.scriptUpdateCheckDisabled&&!y.script.enabled&&!l||!y.script.options.check_for_updates;return l&&y.script.uuid!==l||a||!(E=w.determineSourceURL(y.script))?m.Breach():m.Pledge()}().then(function(){var a=w.determineMetaURL(y.script);if(!a)return m.Pledge();var b=m();la({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(c){4==c.readyState&&200==c.status?
r=D.processMetaHeader(c.responseText):n.warn("update: unable to find meta data @ "+a+" req.status = "+c.status);b.resolve()}});return b.promise()}).then(function(){var a=!!r,b=a&&!!r.version,c=b&&(!y.script.version||D.versionCmp(r.version,y.script.version)==D.versionCmp.eNEWER);return a&&b&&!c?m.Breach():m.Pledge()}).then(function(){return f.getScriptFromURL(E).fail(function(){n.warn("update: failed",y.script.name,E)})}).then(function(a){var b;b=y.script.uuid;var d=D.createScriptFromSrc(a);if(!d.name||
""==d.name||void 0===d.version||d.options.compat_uW_gmonkey)b=D.versionCmp.eERROR;else{var k;b=(k=z.getMetaByUid(b))?k.system?null:d.version==k.version?D.versionCmp.eEQUAL:D.versionCmp(d.version,k.version):D.versionCmp.eNEWER}return b==D.versionCmp.eNEWER?(c++,g=y.script.name,h=E,p=a,m.Pledge()):m.Breach()}).then(function(){if(e.values.notification_silentScriptUpdate)return m.Pledge();var a=d.getMessage("There_is_an_update_for_0name0_avaiable_",g)+"\n"+d.getMessage("Click_here_to_install_it_"),b=
d.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",c=m();R.show(b,a,rea.extension.getURL("images/icon128.png"),e.values.scriptUpdateHideNotificationAfter,c.resolve);return c.promise()}).then(function(c){var d=b||y.script.uuid;return void 0===c||c.clicked?w.doSave({url:h,uuid:d,replace:!d,src:p,ask:!e.values.notification_silentScriptUpdate}).done(function(b){b&&b.installed&&a++}):m.Breach()})});return m.sidebyside(b).then(function(){0==c&&h&&(n.debug("No update found"),
R.show("Narf!",d.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4));return{found:c,installed:a}})},r=null,f={check:function(f,l,c){if(!f&&0>=e.values.scriptUpdateCheckPeriod)return m.Breach();var a=Z.getConfig();if(!f&&Date.now()-a.scripts<Math.max(e.values.scriptUpdateCheckPeriod,36E5))return m.Breach();var b=m();f=function(){g&&(window.clearTimeout(g),g=null);k&&k.cancel();A(l,c).done(function(a){b.resolve(a.installed)}).fail(function(){b.resolve(null)});a=Z.getConfig();
a.scripts=Date.now();Z.setConfig(a)};var g,k,t=function(){k=null;var a=d.getMessage("Script_Update"),b=d.getMessage("Waiting_for_sync_to_finish")+"...";k=R.show(a,b,rea.extension.getURL("images/icon128.png"),6E4)};K.enabled?(K.addSyncDoneCallback(f),K.sync(50,!1),l&&(g=window.setTimeout(t,500))):f();return b.promise()},getScriptFromURL:function(d){var f=m();U({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,revalidate:!0,headers:{Accept:"text/x-userscript, */*"},
url:d},{onload:function(c){4!=c.readyState||200!=c.status&&0!=c.status||c.error?f.reject({error:!0,responseText:c.responseText}):f.resolve(c.responseText)},onerror:function(c){f.reject({error:!0,responseText:c.responseText})},ontimeout:function(){f.reject({timeout:!0,responseText:""})}});return f.promise()},init:function(){var d=function(){r&&(window.clearTimeout(r),r=null);0<e.values.scriptUpdateCheckPeriod&&(r=window.setTimeout(function(){r=null;f.check();d()},36E5))};d();e.addChangeListener("scriptUpdateCheckPeriod",
d)}};return f}();trup=aa;var w=function(){var A=function(c){c.sort(function(a,b){return a.position-b.position});return c},r=function(c){void 0===c.ask&&(c.ask=!0);if(void 0===c.url||null==c.url)c.url="";""===c.force_url&&(c.force_url=null);var a=D.createScriptFromSrc(c.src),b=null,g={heading:null,errors:[],info:[],warnings:[],flags:{}},k=m(),f=Date.now(),h=c.save&&!c.ask&&e.values.editor_easySave,p=c.uuid,y,r;a.name&&void 0!=a.version?r=m.Pledge():(g.errors.push(d.getMessage("Invalid_UserScript__Sry_")+
"\n\n"),c.name&&g.errors.push(d.getMessage("Script_name_0name0",c.name)+"\n\n"),c.url&&g.errors.push(d.getMessage("Downloaded_from_0url0",c.url)),n.warn("scriptman: invalid userscript",g,a),r=m.Breach());r.then(function(){c.replace&&!p&&(p=z.getUidsByName(a.name,a.namespace)[0]);if(p)b=z.getMetaByUid(p);else if(a.uuid)p=a.uuid;else if(c.replace)p=x.createUUID();else return n.warn("scriptman: neither UUID, @uuid nor replace option set"),m.Breach();if(""!==p.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,
""))return n.warn("scriptman: invalid UUID",p),m.Breach();if(!c.clean&&!c.defaultscript&&b&&b.system)return m.Breach()}).then(function(){if(c.clean&&c.name&&c.name!=a.name||-1!=a.name.search("\n"))return g.errors.push(d.getMessage("Invalid_UserScript_name__Sry_")),m.Breach()}).then(function(){if(a.options.compat_uW_gmonkey)return g.errors.push(d.getMessage("This_script_uses_uW_gm_api_")),m.Breach()}).then(function(){if(b){b.name!=a.name&&(g.flags.renamed=!0);if(b.lastModified&&void 0!==c.lastModTime&&
b.lastModified!==c.lastModTime){var k=d.getMessage("some_secs");try{var e=Math.max(1,Math.floor((f-b.lastModified)/1E3));isNaN(e)||(k=e)}catch(p){}g.warnings.push(d.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",k));g.flags.forceAsk=!0}a.version==b.version&&(c.save?g.flags.modification=!0:g.flags.reset=!0);c.clean&&(g.flags.factory=!0);y=!c.internal}else g.flags.first_install=!0,y=!c.internal||c.save;a.includes.length||a.matches.length||h||c.internal||g.warnings.push(d.getMessage("This_script_does_not_provide_any__include_information_"));
g.flags.sync=!!c.sync;g.flags.internal=c.internal;g.flags.ask=c.ask;g.flags.save=c.save}).then(function(){a.uuid=p;a.system=c.defaultscript;a.evilness=w.getEvilness(a);a.position=w.determineLastPosition()+1;a.lastModified=f;if(c.force_meta){var d;if(d=c.force_meta.fileURL)a.fileURL=d;if(d=c.force_meta.lastModified)a.lastModified=d}g.flags.factory||g.flags.reset?b&&(a.lastModified=b.lastModified):(c.force_url&&(a.updateURL=null,a.downloadURL=c.force_url),b&&(a.options.override=b.options.override,a.options.comment=
b.options.comment,a.options.check_for_updates=b.options.check_for_updates));["includes","excludes","matches","connects"].forEach(function(b){a.options.override["orig_"+b]=a[b]});a.options.override.orig_noframes=a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(function(){if(b&&(a.fileURL=b.fileURL,a.position=b.position,b.sync&&(a.sync=b.sync),!g.flags.factory&&!g.flags.reset)){a.enabled=b.enabled;a.options.noframes=
b.options.noframes;a.options.run_at=b.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=b.options.compat_forvarin);c.save&&!c.force_url&&(a.downloadURL=b.downloadURL||a.downloadURL);var k=l.determineMetaURL(b),f=l.determineMetaURL(a),k=k?B.woHash(k):k,f=f?B.woHash(f):f;k==f||h||c.internal||g.warnings.push(d.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[k,f]));c.save||(x.adiff(b.includes,a.includes,"notinfirst").length+x.adiff(b.matches,a.matches,"notinfirst").length+
x.adiff(a.excludes,b.excludes,"notinfirst").length&&g.warnings.push(d.getMessage("At_least_one_of_the_include_match_or_exclude_statements_was_changed_")),x.adiff(b.connects||[],a.connects||[],"notinfirst").length&&g.warnings.push(d.getMessage("At_least_one_new_connect_statement_was_added_")))}}).then(function(){if(b&&!g.flags.factory&&a.version==b.version&&(c.defaultscript||c.noreinstall))return m.Breach()}).then(function(){b?(g.flags.factory||g.flags.reset?(g.flags.reset?(g.heading=d.getMessage("You_are_about_to_reinstall_a_UserScript_"),
g.flags.reinstall=!0):(g.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),g.flags.install=!0),c.internal||g.warnings.splice(0,0,d.getMessage("All_script_settings_will_be_reset_"))):g.flags.modification?g.heading=d.getMessage("You_are_about_to_modify_a_UserScript_"):D.versionCmp(a.version,b.version)==D.versionCmp.eOLDER?(g.heading=d.getMessage("You_are_about_to_downgrade_a_UserScript"),g.flags.downgrade=!0,h||c.internal||g.warnings.splice(0,0,d.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):
(g.heading=d.getMessage("You_are_about_to_update_a_UserScript_"),g.flags.update=!0),g.info.push({label:d.getMessage("Installed_Version_"),value:"v"+b.version})):(g.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),h||c.internal||(g.info.splice(0,0,d.getMessage("Malicious_scripts_can_violate_your_privacy_")),S.getWarningsFor(l.determineSourceURL(a)).forEach(function(a){g.warnings.splice(0,0,a)})),g.flags.install=!0);g.flags.install?g.action=d.getMessage("Install"):g.flags.reinstall?g.action=
d.getMessage("Reinstall"):g.flags.modification?g.action=d.getMessage("Modify"):g.flags.downgrade?g.action=d.getMessage("Downgrade"):g.flags.update&&(g.action=d.getMessage("Update"))}).then(function(){c.url&&(a.fileURL=c.url);c.sync&&(a.sync=c.sync);c.force_options&&x.copy(c.force_options,a.options,(new D.Script).options,!0);c.force_settings&&x.copy(c.force_settings,a,["enabled","position"]);a=w.mergeCludes(a)}).then(function(){var b=!1,c;for(c in a.options)if(-1!=c.search("compat_")&&!0===a.options[c]){b=
!0;break}b&&g.info.push({label:d.getMessage("Note"),value:d.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")})}).then(function(){["requires","resources"].forEach(function(b){a[b]=x.map(a[b],function(b){b.unsafe_url=b.url;b.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;b.url=null;return b})})}).done(function(){k.resolve({script:a,oldscript:b,messages:g,trigger_sync:!!y,short_info:[{label:d.getMessage("Author"),prop:"author"},
{label:d.getMessage("Description"),prop:"description"},{label:d.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){k.reject({messages:g})});return k.promise()},f=function(c){var a=m(),b=c.messages,d=c.script,k=c.trigger_sync,f=function(){var a=l.doModify(d.uuid,d,k)||{};!b.flags.install&&!b.flags.update||b.flags.factory||b.flags.reset||L.tS(d.name,d.fileURL,b.flags.install?"i":"u");b.flags.modification||P.dropAll(d.uuid);(b.flags.first_install||b.flags.factory)&&z.setStorageByUid(d.uuid,{ts:Date.now()});
return a},e={lastModified:void 0,installed:!0,renamed:b.flags.renamed};b.warnings.length||b.flags.ask?X.install(c).done(function(b){b.ok&&f();e.installed=b.ok;e.aborted=b.aborted;a.resolve(e)}).fail(function(b){a.reject(b)}):(f(),a.resolve(e));return a.promise()},h=x.getDebouncer(1E3),l={determineSourceURL:function(c){return c?x.select([c.downloadURL,c.fileURL],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]:null},determineMetaURL:function(c){if(!c)return null;var a,b=w.determineOrigin(c);
b&&b.meta_header?a=c.fileURL:!c.fileURL||b&&!b.meta_url||(a=c.fileURL.replace(".user.js",".meta.js"),c.fileURL==a&&(a=c.fileURL.replace(".tamper.js",".meta.js")),c.fileURL==a&&(a=null));return x.select([c.updateURL,c.downloadURL,a],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]},mergeCludes:function(c){var a,b,d=c.options.override;["includes","excludes","matches"].forEach(function(a){c[a]=d["merge_"+a]&&d["orig_"+a]?d["orig_"+a].slice():[]});if(d.use_includes)for(a=0;a<d.use_includes.length;a++)b=
c.excludes.indexOf(d.use_includes[a]),0<=b&&c.excludes.splice(b,1),c.includes.push(d.use_includes[a]);if(d.use_matches)for(a=0;a<d.use_matches.length;a++)b=c.excludes.indexOf(d.use_matches[a]),0<=b&&c.excludes.splice(b,1),c.matches.push(d.use_matches[a]);if(d.use_excludes)for(a=0;a<d.use_excludes.length;a++)c.excludes.push(d.use_excludes[a]);return c},doSave:function(c){return r(c).then(f)},doRemove:function(c,a){z.removeByUid(c,a);z.setStorageByUid(c,null);P.dropAll(c);return m.Pledge()},doModify:function(c,
a,b){void 0===b&&(b=!0);z.setByUid(c,a,b);return b?P.loadResources(c,a.resources).then(function(){return P.loadRequires(c,a.requires)}).then(function(){var b=[].concat(a.resources).concat(a.requires).map(function(a){return B.sanitize(a.unsafe_url,a.abs_url)});return P.dropAllBut(c,b)}):m.Pledge()},exportToJson:function(c,a){var b=m(),d=w.determineScriptsToRun(null);c&&(d=x.select(d,function(a){return c[a.uuid]}));d=ra(d,!0);a&&!a.storage||d.forEach(function(a){a.storage=z.getStorageByUid(a.uuid)});
d={scripts:d};if(!a||a.global_settings)d.global_settings=u.getValue(q.CONSTANTS.STORAGE.CONFIG,{});b.resolve(d);return b.promise()},importFromJson:function(c){if(!c||!c.scripts||!c.scripts.length)return m.Breach();for(var a={},b=[],d={},k=0,e;e=c.scripts[k];k++)try{var h=m();"new-user-script"!=e.uuid&&(e.storage&&(d[e.uuid]=e.storage),r({uuid:e.uuid,name:e.name,src:e.source,force_settings:{enabled:e.enabled,position:e.position},force_options:e.options,force_meta:{lastModified:e.lastModified},replace:!0,
url:e.file_url||e.update_url,ask:!1}).done(function(b){a[x.createUUID()]=b;h.resolve()}).fail(function(a){n.warn("import: Error @ script",e.name,a);h.resolve()}),b.push(h.promise()))}catch(l){n.warn("import: Error while importing script",e.name,l)}var p=function(){var a=m();m.when(b).always(function(){a.resolve()});return a.promise()}().then(function(){return X.import(a,c.global_settings)}).then(function(b){var c=m(),k=[],e=[];if(b.ok)for(var t=0,h;h=b.import_ids[t];t++)(function(){var b=h;if(a[b]){a[b].messages.warnings=
[];var c=f(a[b]).done(function(){var c;(c=a[b].script.uuid)&&d[c]&&(c=z.setStorageByUid(c,{data:d[c].data||{},ts:Date.now()}),e.push(c))});k.push(c)}})();m.when(k).always(function(){w.reorderScripts();m.when(e).always(function(){c.resolve(b)})});return c.promise()}).then(function(a){return c.global_settings&&a.global_settings?(a=u.setValue(q.CONSTANTS.STORAGE.CONFIG,c.global_settings).then(function(){p.done(function(){window.setTimeout(V.reset,1)});return m.Pledge({global_settings:!0})}),u.setTemporary(!0),
a):m.Pledge({})});return p},installFromUrl:function(c,a,b){var g=m(),k=B.parse(c),f={messages:{errors:[d.getMessage("Unable_to_load_script_from_url_0url0",c)],warnings:[]}};a=a||{};b=b||{};var e=["url",c,JSON.stringify(a)].join("_");if(h.is(e))return n.debug("scriptman: de-bounced installFromUrl",c),m.Breach();h.add(e);if(!k.protocol.match(/(https?|file):/))return n.warn("scriptman: can't install from ",c),m.Breach(f);"file:"!=k.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",
c,"-> more info:","http://tampermonkey.net/faq.php#Q204");aa.getScriptFromURL(c).then(function(d){var k={url:c,src:d,ask:!0,replace:!0};a&&x.each(a,function(b,c){k[c]=a[c]});g.consume(l.installFromSource(d,k,b))}).fail(function(a){a?("file:"!=k.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||f.messages.warnings.unshift(d.getMessage("Tampermonkey_has_no_file_access_permission_")),f.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),b.silent_fail?g.reject(f):X.installError(f).always(function(a){g.reject(a)})):
g.reject()});return g.promise()},installFromSource:function(c,a,b){var g=m(),k={src:c,ask:!0,replace:!0};a&&x.each(a,function(b,c){k[c]=a[c]});l.doSave(k).done(function(a){g.resolve(a.installed)}).fail(function(a){a?(a.heading=d.getMessage("You_are_about_to_install_a_UserScript_"),b.silent_fail?g.reject(a):X.installError(a).always(function(a){g.reject(a)})):g.reject()});return g.promise()},determineLastPosition:function(){var c=0;z.getUidList().forEach(function(a){var d=z.getByUid(a);d.script&&d.cond?
d.script.position&&d.script.position>c&&(c=d.script.position):n.warn("scriptman: inconsistent script entry",a)});var a=new D.Script;a.position>c&&(c=a.position);return c},convertToRegExp:function(c,a){var b,d;try{!a&&1<c.length&&"/"==c.substr(0,1)?b=new RegExp(".*"+c.replace(/^\//g,"").replace(/\/$/g,"")+".*","i"):a?(d=B.getRegExpFromMatch(c),b=new RegExp(d)):(d=B.getRegExpFromInclude(c),b=new RegExp(d,"i"))}catch(k){return n.warn("scriptman: invalid regexp ",c),!1}return b},matchUrl:function(c,a){return""===
c.replace(a,"")},regexify:function(c,a){var b={},d={inc:"rinc",match:"rinc",exc:"rexc"};Object.keys(d).forEach(function(k){var f=c[k]&&c[k].length?c[k].map(function(a){return l.convertToRegExp(a,"match"===k)}).filter(function(a){return!1!==a}):null;if(f||a)b[d[k]]=(b[d[k]]||[]).concat(f||[])});return b},validUrl:function(c,a,b){var d=!1;if(a.rinc){if(a.rinc.every(function(a){return l.matchUrl(c,a)?(n.debug('scriptman: @include "'+a+'" matched'+(b?" ("+b+")":'"')),d=!0,!1):!0}),!d)return d}else d=
!0;a.rexc&&a.rexc.every(function(a){return l.matchUrl(c,a)?(n.debug('scriptman: @exclude "'+a+'" matched'+(b?" ("+b+")":'"')),d=!1):!0});return d},getEvilness:function(c){var a=0;return c.fileURL&&(a=S.getEvilnessOf(c.fileURL))||c.downloadURL&&(a=S.getEvilnessOf(c.downloadURL))||c.updateURL&&(a=S.getEvilnessOf(c.updateURL))?(n.debug("scriptman: found blacklisted script",c),a):0},blackCheckAll:function(){z.getUidList().forEach(function(c){var a=z.getByUid(c);if(a.script&&a.cond){var b=w.getEvilness(a.script);
if(b!==a.script.evilness){if(b||void 0!==a.script.evilness)n.debug("scriptman: write blacklist state of ",a.script.name,b),b&&L.tS(a.script.name,b,"b");a.script.evilness=b;l.doModify(c,a.script,!1)}}})},reorderScripts:function(c,a){var b=l.determineScriptsToRun();if(c)for(var d=0;d<b.length;d++){var k=b[d];k.uuid==c&&(k.position=Number(a)+(k.position<a?.5:-.5))}b=A(b);d=1;for(k=0;k<b.length;k++){var f=b[k];f.position=d++;l.doModify(f.uuid,f,!1)}},getUniqueScriptsForTab:function(c){var a=[];C.get.empty(c.id)?
n.debug("bg: WARN: Tabs.get.urls["+c.id+"] is empty!"):x.each(C.get.urls(c.id),function(b,c){if(T.isAllowed(c))for(var d=w.determineScriptsToRun(c),f=0;f<d.length&&(0===b.frameId||!0!==d[f].options.noframes&&(null!==d[f].options.noframes||!0!==d[f].options.override.orig_noframes));f++){for(var e=!1,h=0;h<a.length;h++)if(a[h].uuid==d[f].uuid){e=!0;break}e||a.push(d[f])}});return a},scriptWillRun:function(c,a){if(a&&c){var b=I.items.regexp.get(c);if(!b){if(!(b=u.getValue(q.CONSTANTS.PREFIX.COND+c,null)))return;
b=l.regexify(b,!0);I.items.regexp.set(c,b)}return!!l.validUrl(a,b,c)}},determineScriptsToRun:function(c,a){var b=[];n.debug("scriptman: determineScriptsToRun @"+c);z.getUidList().forEach(function(d){var k=!0,f=0;c&&(f=Date.now(),k=l.scriptWillRun(d,c),f=Date.now()-f);var e=z.getByUid(d);e.script&&e.cond?(a&&1E3<f&&n.warn("scriptman: checking "+e.script.name+"'s ("+d+") includes and excludes took "+f+"ms!"),k&&b.push(e.script)):n.warn("scriptman: inconsistent script entry",d,e)});return A(b)},isContexter:function(c){return c.options&&
("context-menu"===c.options.run_at||null===c.options.run_at&&"context-menu"===c.options.override.orig_run_at)},determineOrigin:function(c){return l.determineOriginOfUrl(c.fileURL||c.downloadURL||c.updateURL)},determineOriginOfUrl:function(c){if(c){var a=c.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||c.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+
a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((a=c.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&2==a.length)return{id:a[1],token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+a[1],issue_url:"https://greasyfork.org/scripts/"+a[1]+"/feedback"};if((a=c.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],
issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+"/issues"};if((a=c.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&3==a.length)return{id:a[2],token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+a[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+a[2]};if((a=c.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||c.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&
3==a.length)return a.shift(),{id:a.join("/"),token:"gh",url:"https://github.com/"+a.join("/"),issue_url:"https://github.com/"+a.join("/")+"/issues"};if((a=c.match(/https?:\/\/gitlab\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"gl",url:"https://gitlab.com/"+a.join("/"),issue_url:"https://gitlab.com/"+a.join("/")+"/issues"};if((c=c.match(/https?:\/\/bitbucket\.org\/([^/]+)\/([^/]+)\/(?:raw|downloads)\/.*\.user\.js/))&&3==c.length)return c.shift(),
{id:c.join("/"),token:"bb",url:"https://bitbucket.org/"+c.join("/"),issue_url:"https://bitbucket.org/"+c.join("/")+"/issues"}}}};return l}(),z=function(){var d=[],r={init:function(){u.addDifferentOriginChangeListener(q.CONSTANTS.PREFIX.STORE,function(d,e){if(e&&e.hasOwnProperty("value")&&e.origin){var l=d.replace(q.CONSTANTS.PREFIX.STORE,""),c;for(c in e.value.data)e.value.data.hasOwnProperty(c)&&function(){var a=c,b=e.value.data[c];r.notifyStorageListeners({uuid:l},null,function(c){var d={data:{},
ts:0};d.data[a]=b;d.ts=e.value.data.ts;var f={storage:d};void 0===d.data[a]&&(f.removed=a);c(f)})}()}})},getUidList:function(){var d=new RegExp("^"+q.CONSTANTS.PREFIX.SCRIPT_UID),e=[];u.listValues().forEach(function(l){-1!=l.search(d)&&e.push(l.replace(d,""))});return e},getUidsByName:function(d,e){var l=[];r.getUidList().forEach(function(c){var a=r.getMetaByUid(c);!a||a.name!=d||e&&e!=a.namespace||l.push(c)});return l},getUidByName:function(d){return r.getUidsByName(d)[0]},getStorageByUid:function(d){d=
u.getValue(q.CONSTANTS.PREFIX.STORE+d,{ts:0,data:{}});"undefined"===typeof d.ts&&(d.ts=0);"undefined"===typeof d.data&&(d.data={});return d},setStorageByUid:function(d,e){return e?u.setValue(q.CONSTANTS.PREFIX.STORE+d,e):u.deleteValue(q.CONSTANTS.PREFIX.STORE+d)},getMetaByUid:function(d){return u.getValue(q.CONSTANTS.PREFIX.META+d,null)},getByUid:function(d,e){if(!d)return n.error("sb: no UUID set"),{};var l,c=u.getValue(q.CONSTANTS.PREFIX.META+d,null);if(c){var a=function(a){if(a)for(var c=0,d=null;d=
a[c];c++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};a(c.requires);a(c.resources);c.uuid=d;c.grant=c.grant||[];c.options.override.use_connects||(c.connects=c.connects||[],c.options.override.merge_connects=!0,c.options.override.use_connects=[]);void 0===c.options.check_for_updates&&(c.options.check_for_updates=!0);e&&(c=x.copy(c,{}));c.textContent=u.getValue(q.CONSTANTS.PREFIX.SCRIPT+d,c.textContent);c.textContent&&(l=c)}return{script:l,cond:u.getValue(q.CONSTANTS.PREFIX.COND+
d,null)}},setByUid:function(d,e,l){var c={};if(!d)return n.error("sb: no UUID set",e),c;if(null===e.textContent||void 0===e.textContent)throw Error("No script code set!");var a=u.getValue(q.CONSTANTS.PREFIX.META+d),b=!a;u.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+d,e.name);u.setValue(q.CONSTANTS.PREFIX.COND+d,{inc:e.includes,match:e.matches,exc:e.excludes});u.setValue(q.CONSTANTS.PREFIX.SCRIPT+d,e.textContent);var g=x.copy(e,{});g.textContent=null;u.setValue(q.CONSTANTS.PREFIX.META+d,g);l&&(ka.onScriptsChanged(),
b?K.scriptAddedCb(e.name,e):K.scriptChangedCb(e.name,e,a));I.items.rundata.removeAll();I.items.regexp.remove(d);return c},removeByUid:function(d,h){void 0===h&&(h=!0);var l=r.getByUid(d);u.deleteValue(q.CONSTANTS.PREFIX.SCRIPT_UID+d);u.deleteValue(q.CONSTANTS.PREFIX.COND+d);u.deleteValue(q.CONSTANTS.PREFIX.SCRIPT+d);u.deleteValue(q.CONSTANTS.PREFIX.META+d);u.deleteValue(q.CONSTANTS.PREFIX.STORE+d);h&&(ka.onScriptsChanged(),l.script&&l.cond&&(K.scriptRemovedCb(l.script.name,l.script),e.values&&L.tS(l.script.name,
null,"r")));I.items.rundata.removeAll();I.items.regexp.remove(d);return{}},addStorageListener:function(e,h,l,c,a){d.push({tabid:e,id:h,uuid:l,time:c,response:a})},removeStorageListeners:function(e,h){void 0===h&&(h=!0);var l=d;d=[];l.forEach(function(c){try{void 0!==e.tabid&&e.tabid!==c.tabid||void 0!==e.uuid&&e.uuid!==c.uuid||void 0!==e.id&&e.id!==c.id?d.push(c):h&&c.response({})}catch(a){n.debug("sb: listener clear for script",e,"failed! Page reload?!")}})},notifyStorageListeners:function(e,h,l){e=
e||{};h=h||{};d.forEach(function(c){try{void 0!==h.uuid&&c.uuid===h.uuid||void 0!==h.tabid&&c.tabid===h.tabid||void 0!==h.id&&c.id===h.id||void 0!==e.tabid&&e.tabid!==c.tabid||void 0!==e.uuid&&e.uuid!==c.uuid||void 0!==e.id&&e.id!==c.id||l&&l(c.response)}catch(a){n.warn("sb: listener notification for script",e,"failed! Page reload?!")}})}};return r}();scbr=z;var wa=function(){var A={ping:{allow:{insecure:!0},exec:function(a,b,c){c({pong:!0,instanceID:ua,config:{layout:e.values.layout}})}},newTab:{allow:{extpage:!0},
exec:function(a,b,c){("options"==b.extpage||"options"==a.origin?m.Pledge(b.tab):ma()).then(function(b){rea.tabs.create({url:a.url,parent:b},function(a){c({tabId:a.id})})})}},getTab:{allow:{script:!0},exec:function(a,b,c){b.tab&&a.uuid?(O[b.tab.id]||(O[b.tab.id]={}),O[b.tab.id][a.uuid]||(O[b.tab.id][a.uuid]={}),c({data:O[b.tab.id][a.uuid]})):(n.warn("bg: unable to process request",b,a),c({data:null}))}},getTabs:{allow:{script:!0},exec:function(a,b,c){if(a.uuid){var d={};Object.keys(O).forEach(function(b){d[b]=
{};d[b]=O[b][a.uuid]});c({data:d})}else n.warn("bg: unable to process request",b,a),c({data:null})}},setTab:{allow:{script:!0},exec:function(a,b,c){if(b.tab&&a.uuid){O[b.tab.id]||(O[b.tab.id]={});var d={};a.tab&&Object.keys(a.tab).forEach(function(b){d[b]=a.tab[b]});O[b.tab.id][a.uuid]=d}else n.warn("bg: unable to process request",b,a);c({})}},focusTab:{allow:{script:!0},exec:function(a,b,c){(a=b&&b.tab?b.tab.id:null)?rea.tabs.update(a,{active:!0},function(){c({error:rea.runtime.lastError})}):c({error:"internal error"})}},
closeTab:{allow:{script:!0},exec:function(a,b,c){var d=b&&b.tab?b.tab.id:null;d?rea.tabs.query({windowType:"normal"},function(a){1>=a.length?(n.warn("bg:","refused to close last tab!"),c({error:"refused to close last tab!"})):rea.tabs.remove(d,function(){c({})})}):c({error:"internal error"})}},setOption:{allow:{extpage:!0},exec:function(a,b,c){var d="options"==b.extpage||"options"==a.origin;e.setValue(a.name,a.value).always(function(){d?W.create("options.settings").done(function(a){c({items:a,options:e.snapshot})}).fail(function(a){c({error:a,
options:e.snapshot})}):c({})})}},reportAnIssue:{allow:{extpage:!0},exec:function(a,b,c){("options"==b.extpage||"options"==a.origin?m.Pledge(b.tab):ma()).then(function(b){var d,e,f,h;a.uuid&&(d=z.getByUid(a.uuid))&&d.script&&d.cond&&(e=w.determineOrigin(d.script),"author"==a.to&&d.script.supportURL?(f={url:d.script.supportURL},h=e?[a.to,e.token,e.id].join(":"):[a.to,f.url].join(":")):e&&(f=e,h=[f.token,f.id].join(":")),f&&(L.tS(d.script.name,h,"m"),rea.tabs.create({url:f.issue_url||f.url,active:!0,
parent:b},function(){})));c({})})}},begEvent:{allow:{extpage:!0},exec:function(a,b,c){if("dialog"==a.action)ba.dialog.shown(a.extra);else if("clicked"==a.action){var d,e;a.extra&&(d=a.extra.amount,e=a.extra.currency);ba.clicked(a.type,d,e)}else if(ba.button[a.action])ba.button[a.action](a.extra);else n.warn("bg: Warning: unknown request ",a);c({})}},buttonPress:{allow:{extpage:!0},exec:function(a,b,c){b=function(){c({})};if("reset_simple"==a.name)V.reset(b);else if("reset_factory"==a.name)V.factoryReset(b);
else if("reset_sync"==a.name)K.reset().always(b);else if("install_tests"==a.name)(b=ga.framework.prepare(w.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION,b))&&n.error(b);else if("enabled"==a.name)e.setValue(a.name,!e.values[a.name]).always(function(){c({})});else if("installFromUrl"==a.name)w.installFromUrl(a.data).always(function(){c({})});else if("externals_delete"==a.name)P.cleanElement(a.scriptuid,a.safe_url),W.create("options.scripts").done(function(a){c({items:a,options:e.snapshot})}).fail(function(a){c({error:a,
options:e.snapshot})});else if("focus_tab"==a.name)A.focusTab.exec({},{tab:{id:a.tabid}},c);else if("run_script_updates"==a.name)if(a.scriptuid){var d;aa.check(!0,!1,a.scriptuid).done(function(a){d=a}).always(function(){c({scriptuid:a.scriptuid,updatable:d})})}else aa.check(!0,!0),c({});else n.warn("bg: Warning: unknown button "+a.name),c({})}},loadTree:{allow:{extpage:!0},exec:function(a,b,c){W.create(a.referrer,{complete:a.complete,uuid:a.uuid}).done(function(b){b={items:b,i18n:e.values.i18n,options:e.snapshot,
begging:ba.needed()};a.layout&&(b.layout=ia.getLayoutByValue(e.values.layout));c(b)}).fail(function(a){c({error:a,options:e.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(a,b,c){if(a.uuid){var d="options"==b.extpage||"options"==a.origin,f=void 0==a.reload||1==a.reload,h=!1,p=z.getByUid(a.uuid,!0);if(p.script&&p.cond){var l=!1,r=new D.Script;Object.keys(r.options).forEach(function(b){void 0!==a[b]&&(p.script.options[b]=a[b],h|=!0===K.SYNCED[b])});Object.keys(r.options.override).forEach(function(b){-1!=
b.search("merge_")&&void 0!==a[b]&&(p.script.options.override[b]=a[b],l=!0)});["includes","excludes","matches"].forEach(function(b){void 0!==a[b]&&(l=!0,p.script.options.override["use_"+b]=a[b])});["connects","blockers"].forEach(function(b){void 0!==a[b]&&(p.script.options.override["use_"+b]=a[b])});l&&(p.script=w.mergeCludes(p.script));a.temp_connects&&fa.setSessionConnects(p.script.uuid,a.temp_connects);void 0!==a.enabled&&(p.script.enabled=a.enabled);h&&(p.script.lastModified=Date.now());w.doModify(p.script.uuid,
p.script,h).done(function(){f?(void 0!==a.position&&w.reorderScripts(a.uuid,a.position),d?A.loadTree.exec({referrer:"options.scripts"},b,c):rea.tabs.getSelected(null,function(b){W.create("actions").done(function(a){c({items:a,i18n:e.values.i18n,options:{enabled:e.values.enabled,layout:e.values.layout}})}).fail(function(){c({i18n:e.values.i18n,options:{enabled:e.values.enabled,layout:e.values.layout}})});a.uuid&&e.values.autoReload&&rea.tabs.sendMessage(b.id,{method:"reload",frameId:0},function(){})})):
c({})}).fail(function(){c({})})}else c({})}else c({})}},modifyNativeScript:{allow:{extpage:!0},exec:function(a,b,c){if(a.nid){var k=void 0==a.reload||1==a.reload;N.getUserscriptById(a.nid).then(function(c){if(c)if("installed"==a.actionid){if("false"==a.value)return N.uninstall(c)}else{if("enabled"==a.actionid)return N.setEnabled(c,a.value);if("imported"==a.actionid&&"true"==a.value){var g=N.getUserscriptSource(c);if(g)return w.doSave({src:g,ask:!0,replace:!0}).then(function(a){if(a.installed){if("disable"==
e.values.native_import_post_action)return N.setEnabled(c,!1);if("uninstall"==e.values.native_import_post_action)return N.uninstall(c)}});rea.tabs.sendMessage(b.tab.id,{method:"showMsg",msg:d.getMessage("Please_double_check_the_native_script_import_settings__")},function(){})}}else k=!1;return m.Pledge()}).always(function(){k?A.loadTree.exec({referrer:"options.scripts"},b,c):c({})})}else c({})}},saveScript:{allow:{extpage:!0},exec:function(a,b,c){var k=void 0===a.reload||!!a.reload,f=function(a){k?
W.create("options.scripts").done(function(b){a.items=b;a.options=e.snapshot;c(a)}).fail(function(a){c({error:a,options:e.snapshot})}):c({})};if(a.clean){n.debug("bg: clean userscript "+a.uuid);b=z.getByUid(a.uuid);var h=function(b){W.create("options.scripts").done(function(d){c({cleaned:b.installed,items:d,options:e.snapshot});b.installed&&z.notifyStorageListeners({uuid:a.uuid},null,function(b){b({storage:z.getStorageByUid(a.uuid)})})}).fail(function(a){c({error:a,options:e.snapshot})})};b.script&&
b.cond?w.doSave({name:a.name,uuid:a.uuid,src:b.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(function(a){h(a||{installed:!1})}):(n.error(d.getMessage("fatal_error")+" ("+a.uuid+")!!!"),h({installed:!1}))}else if(a.code){var p=c;k&&(p=function(a){w.reorderScripts();f(a)});a.new_script&&(a.uuid=x.createUUID());w.doSave({name:a.name,uuid:a.uuid,force_url:a.force_url,src:a.code,ask:!e.values.editor_easySave,lastModTime:a.lastModTime,save:!0}).always(function(a){p(a||{installed:!1})})}else a.auto_save||
(w.doRemove(a.uuid),w.reorderScripts()),f({})}},saveStorageKey:{allow:{extpage:!0},exec:function(a,b,c){h.saveStorageKey.exec(null,a,b,c)}},exportToJson:{allow:{extpage:!0},exec:function(a,b,c){w.exportToJson(a.ids,a.options).done(function(a){c({json:a})}).fail(function(){c({})})}},importFromJson:{allow:{extpage:!0},exec:function(a,b,c){var k=void 0===a.reload||!!a.reload;w.importFromJson(a.json).fail(function(a){c({error:a||d.getMessage("An_error_occured_during_import_")})}).done(function(a){var b=
{reload:a.global_settings};k&&!b.reload?W.create("options.scripts").done(function(a){b.items=a;b.options=e.snapshot;c(b)}).fail(function(a){c({error:a,options:e.snapshot})}):c(b)})}},download:{allow:{extpage:!0},exec:function(a,b,c){h.download.exec(null,a,b,function(a){(a.error||a.load)&&c(a)})}},askCom:{allow:{extpage:!0},exec:function(a,b,c){X.onMessage(a.data).always(function(b){b.i18n=e.values.i18n;b.options=e.snapshot;b.ext={version:rea.extension.manifest.version};a.data.layout&&(b.layout=ia.getLayoutByValue(e.values.layout));
c(b)})}},installScript:{allow:{extpage:!0},exec:function(a,b,c){if(b.tab){var e={};w.installFromUrl(a.url,{},{silent_fail:!0}).done(function(a){e={data:null,found:!0,installed:a}}).fail(function(a){e.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:d.getMessage("Unable_to_parse_this_")}).always(function(){c(e)})}else n.warn("bg: Error: unable to install script due to empty tabID!")}},execMenuCmd:{allow:{extpage:!0},exec:function(a,b,c){(a=ca.getById(a.id))?a.response({run:!0,menuId:a.id}):
n.warn("bg: Error: unable to find MC id "+a.id);c({})}},unLoad:{allow:{script:!0},exec:function(a,b){a.topframe||a.id&&b.frameId&&C.events.unload(b.tab.id,b.frameId,a.id);return!1}},prepare:{allow:{script:!0},exec:function(a,b,c){if(b.tab){var d=void 0!==b.frameId?b.frameId:a.topframe?0:null,e=B.woHash(a.url);a.cleanup?(C.events.clean(b.tab.id,d,e),Q.setIcon(b.tab.id),Q.setBadge(b.tab.id),c({})):C.events.run(b.tab.id,d,a.id,e,function(d){d=d?da.answer(d,a.url):{fast:!0};c(d);Q.setIcon(b.tab.id);Q.setBadge(b.tab.id)})}else c({})}},
notification:{allow:{script:!0,extpage:!0},exec:function(a,b,c){var d=a.image?a.image:rea.extension.getURL("images/icon128.png");(function(){var c=m();a.highlight&&b.tab?R.highlight(b.tab.id,c.resolve):c.resolve();return c.promise()})().then(function(){var b=m();a.text?R.show(a.title,a.text,d,a.timeout,b.resolve):b.resolve();return b.promise()}).always(function(a){c({clicked:a&&a.clicked})})}},determineScriptsToRun:{allow:{extpage:!0},exec:function(a,b,c){c({scripts:w.determineScriptsToRun(a.url).map(function(a){return a.uuid})})}},
syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(a,b,c){(function(){var a=m();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(b){return b.hint(a.code,{maxerr:999},{})}).always(function(a){c({errors:a})})}},externalMessage:{allow:{insecure:!0},exec:function(a,b,d){a=a.request;var k;if("off"!=e.values.external_connect&&(k=b.url)&&T.isAllowed(k)){for(var f,h,p,l=Object.keys(c.externally_connectable),r=0;r<l.length;r++)if(f=l[r],b=c.externally_connectable[f],
(h=w.regexify({match:[f]}))&&w.validUrl(k,h)&&(-1!=b.indexOf("*")||-1!=b.indexOf(a.method))){p=!0;break}if(p)if("getVersion"==a.method)d({version:rea.extension.manifest.version,id:rea.runtime.short_id});else if("all"!=e.values.external_connect)n.warn("mh: calling external method "+a.method+" is not permitted to "+k+" by the user");else if("isInstalled"==a.method){var m,A,q,u;k=!1;h=a.script.name;(A=z.getUidsByName(h,a.script.namespace)[0])&&(m=z.getByUid(A))&&m.script&&(k=!0,u=m.script.enabled,q=
m.script.version);d({name:h,installed:k,enabled:u,version:q})}else n.warn("mh: unknown external method "+a.method);else n.warn("mh: calling external method "+a.method+" is not permitted to "+k)}}},api:{allow:{script:!0},exec:function(a,b,c){L.tA(a.name,a.type);c()}}},r=function(a){var b=rea.runtime.id,b=!q.REQUESTS.HAS_SENDER_ID&&a.tab||a.id===b,c=null,d=q.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",e=q.REQUESTS.GET_INTERNAL_PAGE_REGEXP();a=a.url?a.url:a.tab?a.tab.url:null;if(d=b&&(a?0==a.search(d):!0))a?
(e=a.match(e))&&2==e.length&&(c=e[1]):c="*";return{id_valid:b,url:a,page:c,extpage:d}},f=function(a,b,c){if(!F.late)return F.registerLateCallback(function(){f(a,b,c)}),!0;var d=A[a.method];if(!d)return n.warn("mh: unknown method "+a.method),!1;if(!d.allow||!d.exec)return n.warn("mh: invalid implementation of "+a.method),!1;var e=r(b),h=e.extpage,p=e.page,e=e.id_valid;h?b.extpage=p:delete a.origin;var l="options"==p,m=!0;if("background"==p||d.allow.insecure||d.allow.extpage&&h||d.allow.options&&l||
d.allow.script&&e&&!h){if(d=d.exec(a,b,function(a){m=!1;c(a)}),!1!==m&&!1!==d)return!0}else return!1===a.topframe&&(h||l)||n.warn("mh: this context doesn't have the permission to call \""+a.method+'"'),!1},h={xhr:{allow:{script:!0},exec:function(a,b,c,d){var f=!1,h=function(){a.disconnect()};b.details.convertBinary=!0;b.details.partialSize=b.details.partialSize||q.XMLHTTPREQUEST.PARTIAL_SIZE;var p={};Object.keys(b.callbacks).forEach(function(a){var c="ondone"===a;if(b.callbacks[a]||c||"onload"===
a)p[a]=function(b){b={data:b.response,exception:b.exception};b[a]=!0;d(b);c&&h()}});p.ondone||(p.ondone=h);var l=function(a){var b=m(),c=[];rea.cookies.getAll({url:a},function(a){c=c.concat(a);b.resolve(c)});return b.promise()},r;b.details.url=B.sanitize(b.details.url,b.url||c.url||null)||b.details.url;q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=e.values.webrequest_modHeaders&&(b.details.headers=b.details.headers||{},b.details.headers.internal=b.uuid,q.REQUESTS.SENDS_ORIGIN&&-1==Object.keys(b.details.headers).map(function(a){return a.toLowerCase()}).indexOf("origin")&&
(b.details.headers.origin=null));(function(){return b.details.cookie&&b.details.url?l(b.details.url).then(function(a){a=a.map(function(a){return a.name+"="+encodeURIComponent(a.value)}).concat([b.details.cookie]).join(";");delete b.details.cookie;b.details.headers=b.details.headers||{};b.details.headers.cookie=a}):m.Pledge()})().then(function(){f||(r=fa.exec(b.details,b.uuid,c||{},p))});return function(){f=!0;r&&r.abort()}}},download:{allow:{script:!0},exec:function(a,b,c,d){H.start(b.details,{onload:function(a){d({load:!0,
data:a})},onprogress:function(a){d({progress:!0,data:a})},onerror:function(a){d({error:!0,data:a})},ontimeout:function(a){d({timeout:!0,data:a})},ondone:function(){a&&a.disconnect();a=null}})}},webRequest:{allow:{script:!0},exec:function(a,b,c,d){a=c.tab.id;c=c.frameId;(void 0!==a&&void 0!==c||!b.uuid)&&ea.scripts.set(a,c,b.uuid,b.rules,function(a){d(a)})}},addStorageListener:{allow:{script:!0},exec:function(a,b,c,d){if(c.tab)return z.addStorageListener(c.tab.id,b.id,b.uuid,Date.now(),d),function(){z.removeStorageListeners({uuid:b.uuid,
id:b.id},!1)};d({error:!0})}},saveStorageKey:{allow:{script:!0},exec:function(a,b,c,d){c.tab?b.uuid&&(a=z.getStorageByUid(b.uuid),a.data[b.key]=b.value,a.ts=b.ts,z.setStorageByUid(b.uuid,a),z.notifyStorageListeners({uuid:b.uuid},{id:b.id},function(a){var c={data:{},ts:0};c.data[b.key]=b.value;c.ts=b.ts;var d={storage:c};void 0===c.data[b.key]&&(d.removed=b.key);a(d)})):n.warn("storage: unable to save storage due to empty tabID!");d({})}},openInTab:{allow:{script:!0},exec:function(a,b,d,e){a=["active"];
var f={url:b.details.url};if(b=b.details.options){for(var h=0;h<a.length;h++)void 0!==b[a[h]]&&(f[a[h]]=b[a[h]]);b.insert&&(f.index=d.tab.index+1);b.setParent&&(f.parent=d.tab)}rea.tabs.create(f,function(a){c.tabId=a.id;Y[a.id]={onClose:function(){e({close:!0})}};e({success:!0,tabId:a.id})});return function(){c.disconnected=!0;c.tabId&&delete Y[c.tabId]}}},nameTab:{allow:{script:!0},exec:function(a,b,d,e){if(c.tabId){var f=3,h=function(){C.listeners.once.whenReady(c.tabId,function(){rea.tabs.sendMessage(c.tabId,
{method:"setForeignAttr",attr:"name",value:b.name},function(a){a?e({name:b.name}):0<f--?h():n.warn("foreignAttr: error setting attr")})})};h()}}},closeTab:{allow:{script:!0},exec:function(a,b,d,e){c.tabId&&Y[c.tabId]&&rea.tabs.remove(c.tabId);e({});window.setTimeout(function(){try{c.disconnected||a.disconnect()}catch(b){}c.disconnected=!0},1E3)}},registerMenuCommand:{allow:{script:!0},exec:function(a,b,c,d){if(c.tab)return ca.add(c.tab.id,b.name,b.accessKey,b.menuId,d),Aa(),function(){ca.clearById(b.menuId);
Aa()};n.warn("Unable to register menu cmd due to empty tabID!");a.disconnect()}},tabWatch:{allow:{extpage:!0},exec:function(a,b,c,d){var e=sa.openAndWatch({url:b.url,index:(c.tab.index||0)+1,parent:c.tab},function(b){b?d({tab:b}):(f(),a.disconnect())}),f=function(){e.cancel()};return f}}},l=function(){var a=function(a,c){var d=a.sender,e=h[c.method];if(!e)return n.warn("mh: unknown method "+c.method),!1;if(!e.allow||!e.exec)return n.warn("mh: invalid implementation of "+c.method),!1;var f=r(d),p=
f.extpage,l=f.page,m="options"==l,f=f.id_valid&&!p;if("background"==l||e.allow.insecure||e.allow.extpage&&p||e.allow.options&&m||e.allow.script&&f)(d=e.exec(a,c,d,function(c){try{a.postMessage(c)}catch(d){n.debug("bg: Error sending port ("+a.name+") message",c)}}))&&a.onDisconnect.addListener(d);else return!1===c.topframe&&(p||m)||n.warn("mh: this context doesn't have the permission to call \""+c.method+'"'),!1};return function(b){if(F.late){var c={};b.onMessage.addListener(function(d){a.apply(c,
[b,d])})}else F.registerLateCallback(function(){l(b)})}}(),c={init:function(){c.externally_connectable_reg=w.regexify({match:Object.keys(c.externally_connectable)});rea.extension.onMessage.addListener(f);rea.extension.onConnect.addListener(l);rea.extension.onConnectExternal.addListener(function(a){a.disconnect()})},externally_connectable:{"*://tampermonkey.net/*":["getVersion"],"https://greasyfork.org/*":["*"],"https://userstyles.org/*":["*"]}};return c}(),ca=function(){var d=[];return{add:function(e,
f,h,l,c){d.push({tabId:e,name:f,accessKey:h,id:l,response:c})},list:function(){return d},listByTabId:function(e){var f={};return d.filter(function(d){return d.tabId==e&&!f[d.name]&&(f[d.name]=!0)})},clearByTabId:function(e){d=d.filter(function(d){return d.tabId!=e})},getByTabId:function(e){return d.filter(function(d){return d.tabId==e})[0]},clearById:function(e){d=d.filter(function(d){return d.id!=e})},getById:function(e){return d.filter(function(d){return d.id==e})[0]}}}(),Fa=function(){return{create:function(){var m,
r,f,h,l,c,a,b,g,k,n,v,p,y;k=null;m={name:d.getMessage("General"),sub_menu_item:!0,items:[]};m.items.push({name:d.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,select:[{name:d.getMessage("Novice"),value:0},{name:d.getMessage("Beginner"),value:50},{name:d.getMessage("Advanced"),value:100}],value:e.values.configMode,desc:d.getMessage("Changes_the_number_of_visible_config_options")});m.items.push({name:d.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:d.getMessage("A_reload_is_required"),
select:[{name:"Browser Default",value:null}].concat(d.supported),value:e.values.i18n,validation:{image:"info",opacity:.9,msg:d.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),url:"http://tampermonkey.net/faq.php#Q500"}});m.items.push({name:d.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:e.values.autoReload,desc:d.getMessage("Auto_reload_on_script_enabled_desc")});m.items.push({name:d.getMessage("Anonymous_statistics"),
level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:e.values.statistics_enabled,validation:{image:"info",opacity:.9,msg:d.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),url:"http://tampermonkey.net/privacy.php#extension"}});m.items.push({name:d.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:e.values.debug,desc:""});m.items.push({name:d.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,
enabled:e.values.showFixedSrc,desc:""});m.items.push({name:d.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,select:[{name:d.getMessage("Debug"),value:60},{name:d.getMessage("Warning"),value:30},{name:d.getMessage("Error"),value:0}],value:e.values.logLevel,desc:""});q.OPTIONS.NATIVE_SCRIPT_IMPORT&&(r={name:d.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},k={},e.values.native_import&&(k=!0===q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:d.getMessage("TM_has_access_to_file_URIs")}:
{image:"critical",msg:d.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q204"}),r.items.push({name:d.getMessage("Enable_Native_Script_Import"),id:"native_import",level:0,option:!0,checkbox:!0,enabled:e.values.native_import,validation:k}),r.items.push({name:d.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:d.getMessage("None"),value:"none"},{name:d.getMessage("Disable_Extension"),value:"disable"},
{name:d.getMessage("Uninstall_Extension"),value:"uninstall"}],value:e.values.native_import_post_action,desc:d.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),k={},e.values.native_import&&(k=N.isPathValid()?{image:"button_ok",msg:d.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:d.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q205"}),r.items.push({name:d.getMessage("Browser_Profile_Path"),
id:"native_import_path",level:0,option:!0,text:!0,width:2,value:e.values.native_import_path,validation:k}));v={name:d.getMessage("TESLA"),sub_menu_item:!0,level:50,need_save:!0,items:[]};v.items.push({name:d.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:e.values.sync_enabled,desc:d.getMessage("Tampermonkey_External_Script_List_Access")});f=function(){var a=[],b={reset_sync:!0};rea.storage.sync.supported&&a.push({name:d.getMessage("Browser_Sync"),value:G.types.eCHROMESYNC,
enable:b});a.push({name:"Google Drive",value:G.types.eGDRIVE,enable:b});return a}();v.items.push({name:d.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:f,value:e.values.sync_type});v.items.push({name:d.getMessage("Sync_Reset"),id:"reset_sync",enabledBy:"sync_type",level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_remote_data_from_sync_Ok_")});c={name:d.getMessage("Appearance"),sub_menu_item:!0,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),
reload:!0};c.items.push({name:d.getMessage("Layout"),id:"layout",level:0,option:!0,select:ia.getLayouts(),value:e.values.layout,desc:""});c.items.push({name:d.getMessage("User_CSS"),id:"layout_user_css",level:100,option:!0,input:!0,value:e.values.layout_user_css,desc:d.getMessage("You_can_add_your_custom_CSS_rules_here_")});k={};"off"==e.values.notification_showUpdate&&(k={image:"critical",msg:d.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});c.items.push({name:d.getMessage("Update_Notification"),
id:"notification_showUpdate",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Show_notification"),value:"notification"},{name:d.getMessage("Open_changelog"),value:"changelog"}],value:e.values.notification_showUpdate,validation:k});c.items.push({name:d.getMessage("Favicon_Service"),id:"favicon_service",level:50,option:!0,select:[{name:d.getMessage("Google"),value:"google"},{name:d.getMessage("DuckDuckGo"),value:"duckduckgo"},{name:d.getMessage("Native"),value:"native",
warning:d.getMessage("Warning_unsafe_site_warnings_might_appear_")}],value:e.values.favicon_service});a={name:d.getMessage("Action_Menu"),sub_menu_item:!0,items:[],level:50};a.items.push({name:d.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:e.values.action_menu_scripts_hide_disabled,desc:""});a.items.push({name:d.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:d.getMessage("1"),value:"1"},{name:d.getMessage("2"),
value:"2"},{name:d.getMessage("3"),value:"3"}].filter(function(a){return a.value<=q.ACTIONMENU.COLUMNS}),value:e.values.action_menu_columns});a.items.push({name:d.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:d.getMessage("Position_"),value:"position"},{name:d.getMessage("Name"),value:"name"},{name:d.getMessage("Enabled"),value:"enabled"}],value:e.values.action_menu_scripts_sort});a.items.push({name:d.getMessage("Icon_badge_info"),id:"appearance_badges",
level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Running_scripts"),value:"running"},{name:d.getMessage("Unique_running_scripts"),value:"running_unique"},{name:d.getMessage("Disabled_scripts"),value:"disabled"}],value:e.values.appearance_badges});(q.RUNTIME.CHROME||q.RUNTIME.FIREFOX)&&a.items.push({name:d.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:e.values.appearance_badge_color});f={name:d.getMessage("Editor"),sub_menu_item:!0,
level:20,need_save:!0,items:[],warning:d.getMessage("A_reload_is_required"),reload:!0};f.items.push({name:d.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:e.values.editor_enabled,desc:""});f.items.push({name:d.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:ia.getEditorThemes(),value:e.values.editor_theme});f.items.push({name:d.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",value:70},
{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],value:e.values.editor_fontSize});f.items.push({name:d.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:d.getMessage("Windows"),value:"windows"},{name:d.getMessage("Sublime"),value:"sublime"},{name:d.getMessage("Emacs"),value:"emacs"},{name:d.getMessage("Vim"),value:"vim"}],value:e.values.editor_keyMap});f.items.push({name:d.getMessage("Indentation_Width"),
id:"editor_indentUnit",level:50,option:!0,select:[{name:d.getMessage("1"),value:1},{name:d.getMessage("2"),value:2},{name:d.getMessage("3"),value:3},{name:d.getMessage("4"),value:4},{name:d.getMessage("5"),value:5},{name:d.getMessage("6"),value:6},{name:d.getMessage("7"),value:7},{name:d.getMessage("8"),value:8},{name:d.getMessage("9"),value:9},{name:d.getMessage("10"),value:10},{name:d.getMessage("11"),value:11}],value:e.values.editor_indentUnit,desc:""});f.items.push({name:d.getMessage("Indent_with"),
id:"editor_indentWithTabs",level:50,option:!0,select:[{name:d.getMessage("Tabs"),value:"tabs"},{name:d.getMessage("Spaces"),value:"spaces"}],value:e.values.editor_indentWithTabs,desc:""});f.items.push({name:d.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:d.getMessage("Classic"),value:"classic"},{name:d.getMessage("Smart"),value:"smart"},{name:d.getMessage("Indent"),value:"indent"}],value:e.values.editor_tabMode,desc:""});f.items.push({name:d.getMessage("Line_break"),id:"editor_lineWrapping",
level:50,option:!0,checkbox:!0,enabled:e.values.editor_lineWrapping,desc:""});f.items.push({name:d.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:e.values.editor_electricChars,desc:""});f.items.push({name:d.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:e.values.editor_autoSave,desc:""});f.items.push({name:d.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:e.values.editor_easySave,
desc:""});f.items.push({name:d.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",level:50,option:!0,checkbox:!0,enabled:e.values.editor_highlightTrailingWhitespace,desc:""});f.items.push({name:d.getMessage("Trim_trailing_whitespace_from_modified_lines"),id:"editor_trimTrailingSpacesFromModifiedLines",level:50,option:!0,checkbox:!0,enabled:e.values.editor_trimTrailingSpacesFromModifiedLines,desc:""});f.items.push({name:d.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",
level:50,option:!0,checkbox:!0,enabled:e.values.editor_autoLint,desc:d.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});f.items.push({name:d.getMessage("Auto_syntax_check_max_length"),id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:e.values.editor_autoLintMaxLen,desc:d.getMessage("Check_only_scripts_up_to_this_size_automatically_")});l={name:d.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};l.items.push({name:d.getMessage("Check_disabled_scripts"),
id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:e.values.scriptUpdateCheckDisabled,desc:""});l.items.push({name:d.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",level:80,option:!0,checkbox:!0,enabled:e.values.notification_silentScriptUpdate,desc:""});l.items.push({name:d.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("Every_6_Hours"),value:216E5},
{name:d.getMessage("Every_12_Hour"),value:432E5},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5}],value:e.values.scriptUpdateCheckPeriod,desc:""});l.items.push({name:d.getMessage("Hide_notification_after"),id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:d.getMessage("Never"),value:0},{name:d.getMessage("15_Seconds"),value:15E3},{name:d.getMessage("30_Seconds"),value:3E4},{name:d.getMessage("1_Minute"),value:6E4},{name:d.getMessage("5_Minutes"),
value:3E5},{name:d.getMessage("1_Hour"),value:36E5}],value:e.values.scriptUpdateHideNotificationAfter,desc:""});h={name:d.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};h.items.push({name:d.getMessage("Update_interval"),id:"external_update_interval",level:0,option:!0,select:[{name:d.getMessage("Always"),value:1},{name:d.getMessage("Every_Day"),value:864E5},{name:d.getMessage("Every_Week"),value:6048E5},{name:d.getMessage("Every_Month"),value:2592E6},{name:d.getMessage("Never"),value:0}],
value:e.values.external_update_interval,desc:""});b={name:d.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};q.OPTIONS.HAS_CSP&&(b.items.push({name:d.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("No"),value:"no"}],value:e.values.webrequest_fixCSP,desc:d.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),b.items.push({name:d.getMessage("Allow_headers_to_be_modified_by_scripts"),
id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Yes"),value:"yes"},{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("No"),value:"no"}],value:e.values.webrequest_modHeaders,warning:d.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),desc:""}));b.items.push({name:d.getMessage("Allow_communication_with_cooperate_pages"),id:"external_connect",level:80,option:!0,reload:!0,select:[{name:d.getMessage("Tampermonkey_and_script_version"),
value:"all"},{name:d.getMessage("Tampermonkey_version"),value:"version"},{name:d.getMessage("Disabled"),value:"off"}],value:e.values.external_connect,desc:d.getMessage("This_option_allows_the_Tampermonkey_homepage_and_some_script_hosting_pages_to_determine_the_Tampermonkey_version_and_whether_a_script_is_installed_")});b.items.push({name:d.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:d.getMessage("Disabled"),value:"ignore"},{name:d.getMessage("Validate_if_supported"),
value:"supported"},{name:d.getMessage("Validate_if_given"),value:"given"},{name:d.getMessage("Enforce"),value:"enforce"}],value:e.values.require_sri_mode,desc:d.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});b.items.push({name:d.getMessage("connect_mode"),id:"connect_mode",level:50,option:!0,select:(80<=e.values.configMode||-1!=["off","casual"].indexOf(e.values.connect_mode)?[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Casual"),value:"casual"}]:
[]).concat([{name:d.getMessage("Ask_if_unknown"),value:"ask"},{name:d.getMessage("Strict"),value:"strict"},{name:d.getMessage("Always_ask"),value:"paranoid"}]),value:e.values.connect_mode,desc:""});q.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(k="temporary"==e.values.incognito_mode?{}:{image:"critical",msg:"Permanent mode is still a BETA feature!"},b.items.push({name:d.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:d.getMessage("Temporary"),
value:"temporary"},{name:d.getMessage("Permanent"),value:"permanent"}],value:e.values.incognito_mode,validation:k}));b.items.push({name:d.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Blacklist"),value:"black"},{name:d.getMessage("Whitelist"),value:"white"},{name:d.getMessage("Both"),value:"black+white"}],value:e.values.page_filter_mode,desc:""});b.items.push({name:d.getMessage("Whitelisted_Pages"),id:"page_whitelist",
level:50,option:!0,input:!0,array:!0,value:e.values.page_whitelist,desc:""});b.items.push({name:d.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:e.values.forbiddenPages,desc:""});g={name:d.getMessage("BlackCheck"),sub_menu_item:!0,level:50,items:[]};g.items.push({name:d.getMessage("Script_Blacklist_Source"),id:"script_blacklist_type",level:50,option:!0,select:[{name:d.getMessage("Disabled"),value:"off"},{name:d.getMessage("Server_And_Manual"),value:"server"},
{name:d.getMessage("Only_Manual"),value:"only_manual"}],value:e.values.script_blacklist_type});g.items.push({name:d.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:d.getMessage("severity_1"),value:1},{name:d.getMessage("severity_2"),value:2},{name:d.getMessage("severity_3"),value:3},{name:d.getMessage("severity_4"),value:4},{name:d.getMessage("severity_5"),value:5},{name:d.getMessage("severity_6"),value:6},{name:d.getMessage("severity_7"),value:7},
{name:d.getMessage("severity_8"),value:8},{name:d.getMessage("severity_9"),value:9},{name:d.getMessage("severity_10"),value:10}],value:e.values.script_blacklist_severity});g.items.push({name:d.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:e.values.require_blacklist,desc:""});if(q.OPTIONS.CAN_DOWNLOAD){var u=!1;k={};x.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){u|=H.is_whitelisted(a)});u&&(k={image:"critical",
msg:d.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});y={name:d.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};y.items.push({name:d.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:x.select([{name:d.getMessage("Default"),value:H.staticVars.DEFAULT},{name:d.getMessage("Disabled"),value:H.staticVars.OFF},{name:d.getMessage("Native"),value:H.staticVars.NATIVE},
{name:d.getMessage("Browser_API"),value:rea.downloads.supported?H.staticVars.CHROME:null}],function(a){return a.value}),value:e.values.downloads_mode,desc:d.getMessage("The_Browser_API_mode_requires_a_special_permission_")});y.items.push({name:d.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:e.values.downloads_extension_whitelist,desc:d.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),
validation:k})}n={name:d.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};q.RUNTIME.FAST_EXEC_SUPPORT&&(k="fast"==e.values.runtime_inject_mode?{image:"critical",msg:"This might cause higher CPU usage!"}:{},n.items.push({name:d.getMessage("Inject_Mode"),id:"runtime_inject_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),value:"default"},{name:d.getMessage("Instant"),value:"instant"},{name:d.getMessage("Normal"),value:"normal"}],value:e.values.runtime_inject_mode,validation:k}));
n.items.push({name:d.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:d.getMessage("Default"),value:"byscript"},{name:d.getMessage("Always"),value:"on"},{name:d.getMessage("Disabled"),value:"off"}],value:e.values.runtime_strict_mode});k={name:d.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};k.items.push({name:d.getMessage("Script_URL_detection"),id:"scriptUrlDetection",level:80,option:!0,select:[{name:d.getMessage("Auto"),value:"auto"},{name:d.getMessage("Disabled"),
value:"manual"}],value:e.values.scriptUrlDetection});k.items.push({name:d.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:e.values.script_templates});p={name:d.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};p.items.push({name:d.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_restart_Tampermonkey_Ok_")});p.items.push({name:d.getMessage("Factory_Reset"),
id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:d.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});ga&&p.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:"This will install a lot of test scripts!"});return[m,c,a,l,h,void 0,v,r,void 0,f,b,g,y,k,n,p].filter(function(a){return!!a})}}}(),W=function(){return{create:function(A,r){A=A||"";r=r||{};var f=function(c){return m.onebyone(c).fail(function(){n.warn("tree: wait failed!")}).then(function(a){return a.filter(function(a){return a})})},
h=function(c,a){for(var b=c.replace(/\.$/,"").split("."),d=l;b.length;){var e=b.shift();if(d[e]){if("function"===typeof d[e])return function(){return d[e](r,!a)};d=d[e];b.length||b.unshift("root")}else return n.warn("tree: unable to find",c,r),function(){return m.Pledge([])}}n.warn("tree: unable to find",c,r);return function(){return m.Pledge([])}},l={actions:{root:function(){var c=m();rea.tabs.getSelected(null,function(a){r.tab=a;a=f([h("actions.general"),h("actions.scripts"),h("actions.commands")]);
c.consume(a)});return c.promise()},general:function(){var c=r.tab,a=c?c.url:null,b=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",c=[],g={name:"enabled",sub_menu_item:!0,pos:"top",items:[]};g.items.push({name:d.getMessage("Enabled"),display:e.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});c.push(g);"manual"==e.values.scriptUrlDetection&&oa.isScriptUrl(a)&&g.items.push({name:d.getMessage("Install_this_script"),image:"script_download",id:"installFromUrl",data:a,
button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:d.getMessage("Dashboard"),image:"utilities",url:rea.extension.getURL("options.html")+"#"+["url="+J.Base64.encode(b),"nav=dashboard"].join("&"),newtab:!0});b="version="+rea.extension.manifest.version+"&ext="+rea.runtime.short_id;a.items.push({image:"info",urls:[{name:" "+d.getMessage("Help"),url:"http://tampermonkey.net/faq.php?"+b,newtab:!0},{name:" "+d.getMessage("Changelog"),url:"http://tampermonkey.net/changelog.php?"+
b,newtab:!0}]});c.push(a);return m.Pledge(c)},scripts:function(){var c=r.tab,a=c?c.url:null,b=[],g=a&&4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",f,h={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},c=w.getUniqueScriptsForTab(c),l=da.getContexters(0,null),c=ra([].concat(c).concat(l)),p;"position"!=e.values.action_menu_scripts_sort&&("name"==e.values.action_menu_scripts_sort?p=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?
1:0}:"enabled"==e.values.action_menu_scripts_sort&&(p=function(a,b){return b.enabled-a.enabled}));e.values.action_menu_scripts_hide_disabled&&(c=c.filter(function(a){return a.enabled}));p&&c.sort(p);!e.values.action_menu_scripts_hide_disabled&&2<Math.min(e.values.action_menu_columns,q.ACTIONMENU.COLUMNS)?(f={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},c.forEach(function(a){(a.enabled?h:f).items.push(a)}),b.push(h),f.items.length&&b.push(f)):(f=h,h.items=h.items.concat(c),b.push(h));
e.values.enabled&&!c.length&&a&&(T.isAllowed(a)?h.items.push({name:d.getMessage("No_script_is_running"),image:"info"}):h.items.push({name:d.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));a=d.getLocale();e.values.enabled&&("3"==e.values.action_menu_columns||100>e.values.configMode||!c.length)&&(c.length?(p={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},b.push(p)):p=h,p.items.push({name:d.getMessage("Get_new_scripts___"),image:"script_download",url:"http://tampermonkey.net/scripts.php"+
(a?"?locale="+a:""),newtab:!0}),p.items.push({name:d.getMessage("Add_new_script___"),image:"script_add",url:rea.extension.getURL("options.html")+"#url="+J.Base64.encode(g)+"&nav=new-user-script",newtab:!0}));return m.Pledge(b)},commands:function(){var c=r.tab,a=[],b=d.getLocale(),f={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]},k=c.id,c=[],k=null==k||void 0==k?ca.list():ca.listByTabId(k),h;for(h in k)if(k.hasOwnProperty(h)){var l=k[h];c.push({name:l.name,id:l.id,accessKey:l.accessKey,
image:"menu_cmd",menucmd:!0})}c.length&&(f.items=c);f.items.push({name:d.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});80<=e.values.configMode&&f.items.push({name:d.getMessage("Report_a_bug"),image:"bug",url:"http://tampermonkey.net/bug",newtab:!0});f.items.push({name:d.getMessage("Please_consider_a_contribution"),image:"contrib",url:"http://tampermonkey.net/contrib.php"+(b?"?locale="+b:""),newtab:!0});a.push(f);return m.Pledge(a)}},options:{root:function(){return f([h("options.general"),
h("options.verification"),h("options.scripts"),h("options.settings")])},general:function(){var c,a=[];a.push({name:"Version",id:null,version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==e.values.incognito_mode?a.push({globalhint:!0,image:"critical",value:d.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")}):(c=va.updateAvailable())&&a.push({globalhint:!0,image:"info",class:"information",value:d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",
rea.extension.manifest.name,c)});return m.Pledge(a)},verification:function(){var c=[];ha.getWarnings().forEach(function(a){c.push({globalhint:!0,image:"critical",value:a.text,description:a.description,info_url:a.url})});return m.Pledge(c)},scripts:{root:function(c,a){var b=m(),e={name:d.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(c.complete||!a)return f(x.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return h(a)}));
e.referrer="options.scripts";e.partial=!0;return f([h("options.scripts.new")])})().done(function(a){e.items=a;b.resolve([e])}).fail(b.reject);return b.promise()},"new":function(){var c=[];c.push({name:d.getMessage("New_userscript"),id:null,image:"script_add",icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",position:-1,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return m.Pledge(c)},natives:function(){var c=[],a=m();N.getAllUserscripts().always(function(b){b=
b||[];b.forEach(function(a){c.push({name:a.name,uuid:a.id,icon:a.icon,code:null,position:0,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:a.enabled,version:a.version,description:a.description,nativeScript:!0})});a.resolve(c)});return a.promise()},userscripts:{root:function(c,a){var b=c.complete||!a?null:"options.scripts.userscripts",b=ra(w.determineScriptsToRun(null),!0,b),e=b.length,f=d.getLocale();b.push({name:d.getMessage("No_script_is_installed"),image:"info",visible:!e});b.push({name:d.getMessage("Get_some_scripts___"),
image:"edit_add",url:"http://tampermonkey.net/scripts.php"+(f?"?locale="+f:""),newtab:!0,visible:!e});return m.Pledge(b)},source:function(c){if(!c.uuid)return m.Pledge([]);c=z.getByUid(c.uuid);if(c.script&&c.cond)return c=e.values.showFixedSrc?na.mkCompat(c.script.textContent,c.script,"off"!=e.values.runtime_strict_mode):c.script.textContent,m.Pledge([c]);n.warn("tree: unable to process ",c);return m.Breach()},storage:function(c){return c.uuid?m.Pledge([z.getStorageByUid(c.uuid).data]):m.Pledge([])}}},
settings:function(c,a){var b=m(),e={name:d.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},f;c.complete||!a?f=m.Pledge(Fa.create()):(e.referrer="options.settings",f=m.Pledge());f.done(function(a){e.items=a;b.resolve([e])}).fail(b.reject);return b.promise()}}};n.debug("tree: loading",A,r);return h(A,!0)()}}}(),ra=function(d,m,f){var h=[],l=new D.Script;["author","copyright"].forEach(function(c){l[c]=!1});Object.keys(d).forEach(function(c){var a=d[c],b;if(m){b={};var g=["textContent",
"requires","resources"];Object.keys(l).forEach(function(c){-1==g.indexOf(c)&&(x.toType(l[c]),b[c]=a[c])});f?(b.referrer=f,b.length=a.textContent.length):b.code=a.textContent;["requires","resources"].forEach(function(c){b[c]=x.map(a[c],function(b){var c=b.url||B.sanitize(b.unsafe_url,b.abs_url),d=P.getElement(a.uuid,c),e=0,f=null,g=null;d&&d.data&&(d.data.content&&(e=d.data.content.length),g=d.data.sri,f=d.ts);return{display_url:b.url||b.unsafe_url,url:c,data:{length:e},sri:g,ts:f}})});b.origin=w.determineOrigin(a);
b.contexter=w.isContexter(a);b.temp_connects=fa.getSessionConnects(a.uuid);c=z.getStorageByUid(a.uuid);b.storage_key_count=Object.keys(c.data).length;b.lastUpdated=a.lastUpdated}else b={name:a.name,uuid:a.uuid,system:a.system,support:!!a.supportURL,origin:!!w.determineOrigin(a),contexter:w.isContexter(a),enabled:a.enabled,position:a.position};b.blacklisted=a.evilness>=e.values.script_blacklist_severity;a.evilness&&(b.warnings=S.getWarningsFor(w.determineSourceURL(a)));b.file_url=a.downloadURL||a.fileURL;
b.positionof=d.length;b.userscript=!0;a.icon64||a.icon||(b.icon64=rea.extension.getURL("images/txt.png"));a.options&&Object.keys(l.options).forEach(function(c){b[c]=a.options[c]});h.push(b)});return h},V={run:function(d,e){var f=1,h=function(){0==--f&&(e&&e(),rea.page.reload())};if("config"==d){var l=u.listValues();Object.keys(l).forEach(function(c){c=l[c];-1==c.search(q.CONSTANTS.PREFIX.SCRIPT)&&-1==c.search(q.CONSTANTS.PREFIX.COND)&&-1==c.search(q.CONSTANTS.PREFIX.STORE)&&-1==c.search(q.CONSTANTS.PREFIX.META)&&
(f++,u.deleteValue(c).always(h))})}else"factory"==d&&(f++,H.remove_permission().done(h),f++,u.factoryReset().always(h));h()},reset:function(d){V.run(null,d)},factoryReset:function(d){V.run("factory",d)},configReset:function(d){V.run("config",d)}},Q=function(){var m=function(){rea.runtime.lastError&&void 0},r={init:function(){r.setIcon();var d=e.values.appearance_badge_color||"#ee3131";"#"!==d[0]&&(d="#"+d);rea.browserAction.setBadgeBackgroundColor({color:d})},setIcon:function(f){var h,l;l=null;var c=
h=!1;void 0===f||C.get.empty(f)||(h=C.get.blocker(f),c=C.get.forbidden(f));c?(h="_forbidden",l=d.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):h?(h="_blocker",l=d.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):h=e.values.enabled&&void 0!==f?"":"_grey";n.debug("badge: set icon "+h);h={path:rea.extension.getURL("images/icon"+h+".png")};l={title:l?l:rea.extension.manifest.name};null!=f&&(h.tabId=f,l.tabId=
f);try{rea.browserAction.setIcon(h,m),rea.browserAction.setTitle(l)}catch(a){n.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:function(d){var h=0;"off"==e.values.appearance_badges?h=0:"running"==e.values.appearance_badges?d&&!C.get.empty(d)&&(h=C.get.stats(d).running):"running_unique"==e.values.appearance_badges?d&&!C.get.empty(d)&&(h=C.get.stats(d,!0).unique):"disabled"==e.values.appearance_badges&&d&&!C.get.empty(d)&&(h=C.get.stats(d).disabled);n.debug("badge: set "+h);h?rea.browserAction.setBadgeText({text:h.toString(),
tabId:d}):rea.browserAction.setBadgeText({text:"",tabId:d})}};return r}(),ba=function(){var d=null,e={init:function(){d=u.getValue(q.CONSTANTS.STORAGE.BEGGING,null);var f,h=Date.now();d?(f=u.getValue(q.CONSTANTS.STORAGE.LAST_START,0))&&12096E5<h-f&&(d.later={type:"after_pause",ts:h},e.save()):(d={first_run:{type:"from_init",ts:h}},e.save())},save:function(){u.setValue(q.CONSTANTS.STORAGE.BEGGING,d)},needed:function(){var e=Date.now(),h=d.first_run?d.first_run.ts+12096E5<e:!0,l=!d.hide,c=!d.contributed,
e=d.later?d.later.ts+12096E5<e:!0;return!q.RUNTIME.DOLPHIN&&h&&l&&c&&e},clicked:function(d,e,l){L.tG("clicked",d,e+l)},dialog:{shown:function(f){var h=Date.now();d.dialog={ts:h,extra:f};e.save();L.tG("dialog")}},button:function(){var f={};["contributed","later","hide"].forEach(function(h){f[h]=function(f){var c=Date.now();d[h]={ts:c,extra:f};e.save();L.tG("button",h)}});return f}()};return e}(),ka=function(){var d=function(a,b){n.debug(a,b);if(b&&a.menuItemId){var c=z.getByUid(a.menuItemId);c&&c.script?
xa.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},c.script,!0).then(function(c){var d=m();c.method="executeScript";a.frameUrl?c.url=B.woHash(a.frameUrl):c.topframe=!0;rea.tabs.sendMessage(b.id,c,d.resolve);return d.promise()}):n.debug("ctxm: unable to find script "+a.menuItemId,a,b)}},e=[],f=null,h=!1,l=function(a){var b=[];x.each(a,function(a){var c=m();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:f,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},
function(){c.resolve()});e.push(a.uuid);b.push(c.promise())});return m.when(b)},c=function(){var a=m();rea.contextMenus.removeAll(function(){f=null;a.resolve()});return a.promise()},a=function(){var a=m();c().then(function(){f=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){a.resolve()})});return a.promise()},b=function(){var b=da.getContexters(0,null);if(b.length){var d;d=f?m.Pledge():a();return d.then(function(){return l(b)})}return c().then(g.clean)},
g={init:function(){rea.contextMenus.supported&&(g.clean().then(b).then(function(){h=!0}),rea.contextMenus.onClicked.addListener(d))},clean:function(){var a=m();e.forEach(function(a){rea.contextMenus.remove(a)});e=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&h)return g.clean().then(b)},getContexterCount:function(){return e.length}};return g}(),ea=function(){var d={},m={},f=("TM_"+x.createUUID().substr(0,5)).toLowerCase(),h=["x-webkit-csp","x-content-security-policy",
"content-security-policy"],l=function(a,b){var c,d,e,f,g=a.split(";");g.forEach(function(a,b){0===a.search(/^\s*script-src /)?d=b:0===a.search(/^\s*default-src /)&&(e=b)});var h,k;void 0!==e&&void 0===d&&(c=!0,g.push(g[e].replace(/default-src /,"script-src ")),d=g.length-1);void 0!==d&&(k=!1,h=g[d],-1==h.search(/'unsafe-eval'/)&&(k=!0,h=h.replace(/script-src /,"script-src 'unsafe-eval' ")),-1!=h.search(/'none'/)&&(k=!0,h=h.replace(/ 'none'/,"")),q.RUNTIME.FIREFOX&&(-1==h.search(/'unsafe-inline'/)&&
(k=f=!0,h=h.replace(/script-src /,"script-src 'unsafe-inline' ")),-1==h.search(/'strict-dynamic'/)&&-1!=h.search(/ '(nonce|sha[0-9]+)-[^\']+'/)&&(k=!0,h=h.replace(/ '(nonce|sha[0-9]+)-[^\']+'/g," *"))),k&&(g[d]=h,c=!0));void 0!==e&&(k=!1,h=g[e],f&&-1!=h.search(/ 'self'/)&&(k=!0,g[e]=h.replace(/default-src /,"default-src blob: data: ")),k&&(c=!0));return c?g.join(";"):null},c=function(a,b){var c,d=a.url;Object.keys(b).forEach(function(a){var e=b[a];x.each(e.rules,function(a,b){var f,g;if((f=a.selector)&&
(g=a.action)){var h,k=e.id+"/"+b;(h=I.items.regexp.get(k))||(h=w.regexify({inc:f.include,match:f.match,exc:f.exclude}),I.items.regexp.set(k,h));if(w.validUrl(d,h)){g.cancel&&(n.debug("webRequest: request was canceled by script "+e.uuid,d,a,e),e.callback&&e.callback({type:"cancel",details:{rule:a,url:d}}),c={cancel:!0});if(g.redirect){var l,p,m,r;g.redirect.url?l=g.redirect.url:g.redirect.regex&&(p=g.redirect.regex.from)&&(m=g.redirect.to)&&(r=d.match(p,m))&&(r.shift(),l=d,r.concat(["","",""]).forEach(function(a,
b){l=l.replace("$"+b,a||"")}));f=function(b){n.warn("webRequest: error while request redirect by script "+e.uuid,d,a,e);e.callback&&e.callback({type:"redirect",message:"error",details:{description:b,rule:a,url:d,redirect_url:l}})};if(!l){f("unable to determine the redirect URL");return}l=B.woHash(l);T.isAllowed(l)?w.scriptWillRun(e.uuid,l)?(n.debug("webRequest: request was redirected by script "+e.uuid,d,l,a,e),e.callback&&e.callback({type:"redirect",details:{rule:a,url:d,redirect_url:l}}),c={redirectUrl:l}):
f("the redirect URL needs to be included by the scripts @include or @match tag"):f("the redirect URL is filtered by the security settings")}if(c)return!1}}})});return c},a=function(a){var b=[],c=a.requestHeaders||[],d,e,g={},h=new RegExp("^"+f),c=c.filter(function(c){if(c.name&&0==c.name.search(h))e=c.name.replace(h,""),g[e.toLowerCase()]=!0,"internal"==e?m[a.requestId]=c.value:c.value&&b.push({name:e,value:J.decodeS(c.value)}),d=!0;else return!0});if(d)return{requestHeaders:c.filter(function(a){return!a.name||
!g[a.name.toLowerCase()]}).concat(b)}},b=function(a){if(F.late)if("main_frame"==a.type){if(C.events.reset(a.tabId,!0),0<a.tabId&&"POST"!=a.method&&"auto"==e.values.scriptUrlDetection&&oa.isScriptUrl(a.url))return w.installFromUrl(a.url,{},{silent_fail:!0}).fail(function(b){n.info("webRequest: user script detected @ "+a.url+" was invalid",b?b.messages:"");rea.tabs.update(a.tabId,{url:a.url+"#bypass=true"},function(){})}).done(function(){q.RUNTIME.EDGE&&rea.tabs.query({windowType:"normal"},function(b){b.forEach(function(b){b.id===
a.tabId&&rea.tabs.update(b.id,{url:b.url},function(){})})})}),q.RUNTIME.EDGE?{cancel:!0}:{redirectUrl:"javascript:history.back()"}}else{var d,f;if((d=C.get.requests(a.tabId,a.frameId))&&(f=c(a,d)))return f}else F.registerLateCallback(function(){b(a)})},g=function(a){if(F.late){var b=a.responseHeaders||[];if("xmlhttprequest"==a.type){var c,f,k;(c=m[a.requestId])&&delete m[a.requestId];(f=d[a.requestId])&&delete d[a.requestId];if(c&&(q.XMLHTTPREQUEST.COOKIE_PASSTHROUGH||b.forEach(function(a){a.name&&
a.value&&-1!=a.name.toLowerCase().indexOf("set-cookie")&&(b.push({name:"tm-setcookie"+rea.runtime.short_id.toLowerCase(),value:a.value}),k=!0)}),f&&(b.push({name:"tm-finalurl"+rea.runtime.short_id.toLowerCase(),value:f}),k=!0),k))return{responseHeaders:b}}else{var n,t,u,v=q.OPTIONS.HAS_CSP&&"yes"==e.values.webrequest_fixCSP;b.some(function(a){if(a.name)return a=a.name.toLowerCase(),t|="location"==a,v&&(u|=-1!=h.indexOf(a)),t});if(!t&&(C.events.response(a.tabId,a.frameId,a.url)&&u&&b.forEach(function(c,
d){if(c.name&&c.value){var e=c.name.toLowerCase();-1!=h.indexOf(e)&&(e=l(c.value,a))&&(n=!0,b[d]={name:c.name,value:e})}}),q.RUNTIME.FAST_EXEC_SUPPORT&&-1!=["instant"].indexOf(e.values.runtime_inject_mode)&&(f=C.events.run(a.tabId,a.frameId,null,a.url))&&(c=B.parse(a.url),c=c.pathname+c.search,c="TM_"+rea.runtime.short_id+J.Base64.encode(c.length+c).substr(0,255).replace(/[#=\/]/g,"_")+Date.now(),f=da.answer(f,a.url),f=JSON.stringify(f),f=new Blob([f],{type:"binary/octet-stream"}),f=URL.createObjectURL(f),
C.set.objurl(a.tabId,a.frameId,f),b.push({name:"set-cookie",value:c+"="+window.encodeURIComponent(f)+"; max-age=15;"}),n=!0),n))return{responseHeaders:b}}}else F.registerLateCallback(function(){g(a)})},k=function(a){d[a.requestId]=a.redirectUrl},t=function(a){F.late?a.fromCache&&C.events.response(a.tabId,a.frameId,a.url):F.registerLateCallback(function(){t(a)})},u=function(a){C.events.reset(a.tabId,!0)};return{getPrefix:function(){return f},init:function(c){try{var d=q.RUNTIME.EDGE?["http://*/*",
"https://*/*"]:["<all_urls>"];c?(rea.webRequest.onBeforeRequest.addListener(b,{urls:d,types:["main_frame","sub_frame","script","xmlhttprequest"].concat(q.RUNTIME.WEBREQUEST_WEBSOCKET?["websocket"]:[])},["blocking"]),rea.webRequest.onHeadersReceived.addListener(g,{urls:d,types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","responseHeaders"]),q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&rea.webRequest.onBeforeRedirect.addListener(k,{urls:d,types:["xmlhttprequest"]},[]),rea.webRequest.onResponseStarted.addListener(t,
{urls:d,types:["main_frame","sub_frame"]},[]),rea.webRequest.onErrorOccurred.addListener(u,{urls:d,types:["main_frame"]})):q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=e.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(a,{urls:d,types:["xmlhttprequest"]},["blocking","requestHeaders"]);rea.webRequest.handlerBehaviorChanged()}catch(f){n.warn("webRequest: error initializings",f.message)}},scripts:{set:function(a,b,c,d,e){var f=[];d.forEach(function(a){var c="string"===typeof a.selector?
{include:[a.selector]}:a.selector;["include","match","exclude"].forEach(function(b){"string"===typeof a.selector[b]&&(a.selector[b]=[a.selector[b]])});var b=a.action;if("string"===typeof b){var d=b,b={};b[d]=!0}"string"===typeof a.action.redirect&&(a.action.redirect={url:a.action.redirect});f.push({selector:c,action:b})});C.set.requests(a,b,c,{id:c+"@"+a+":"+b+"#"+Date.now(),rules:f,uuid:c,callback:e})}}}}(),Ga=function(){var d=function(d){C.events.commited(d.tabId,d.frameId,d.url)};return{init:function(){rea.webNavigation.supported&&
rea.webNavigation.onCommitted.addListener(d)}}}(),F={late:!1,callbacks:[],init:function(){},registerLateCallback:function(d){n.debug("toea: register callback");F.callbacks.push(d)},setReady:function(){n.debug("toea: run "+F.callbacks.length+" callbacks");F.late=!0;for(var d=0;d<F.callbacks.length;d++)F.callbacks[d]();F.callbacks=[]}},Ha=function(){var d=!1,e=null,f=function(){d||(n.debug("Unloader.onbeforeunload()"),e&&e(),d=!0)};return{init:function(d){e=d;window.addEventListener("beforeunload",
f,!1)}}}(),va=function(){var A=null,r=rea.extension.manifest.version,f=null,h=!1,l=!1,c=function(){if(F.late){var a="version="+r+"&ext="+rea.runtime.short_id+"&updated=true",b;h?(b="http://tampermonkey.net/installed.php?"+a,l=!0):(a+="&old="+f,b="http://tampermonkey.net/changelog.php?"+a);"off"!=e.values.notification_showUpdate&&("notification"==e.values.notification_showUpdate?R.showUpdate(d.getMessage("Updated_to__0version0",r),d.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),
function(a){a.clicked&&rea.tabs.create({url:b},function(){})}):"changelog"==e.values.notification_showUpdate&&(l||(b+="&intr=true"),l=!0,rea.tabs.create({url:b,active:l},function(){})))}else F.registerLateCallback(c)},a=function(){var a=null,b,c=m(),d=function(){b&&(b=null,c.resolve(!!a))};b=window.setTimeout(d,300);rea.idle.queryState(q.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});return c.promise()},b=function(a){F.late?(n.debug("upd: onInstalled",a),a||(a={reason:"mandatory_argument_is_not_set"}),
"chrome_update"==a.reason?L.tB({updated:!0}):"install"!=a.reason&&"update"!=a.reason||p.scheduleNotification(a.previousVersion,"install"==a.reason)):F.registerLateCallback(function(){b(a)})},g=function(){var a=m(),b=function(){var b=Date.now(),c=u.getValue(q.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-c)/1E3),c=b<=q.MISC.DISTURBANCE_ALLOWED;n.debug("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};F.late?b():F.registerLateCallback(b);return a.promise()}(),k=function(){var b=!1,d=!1;a().then(function(a){d=
a;return g}).then(function(a){b=a}).always(function(){l=!d||b;c();v=!0})},t=null,v=!1,p={scheduleNotification:function(a,b){v||(f=a,h|=b,t&&window.clearTimeout(t),t=window.setTimeout(k,1E3))},updateAvailable:function(){return A}};rea.runtime.onInstalled.addListener(b);rea.runtime.onUpdateAvailable.addListener(function(a){n.info("An update to version",a.version,"is available");A=a.version;window.setTimeout(function(){R.show(d.getMessage("Update"),d.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",
rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),6E4)},864E5)});(function(){F.registerLateCallback(function(){u.setValue(q.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return p}(),Ia=function(d){(function(){var n=m();"toggle-enable"==d?(e.values.enabled=!e.values.enabled,n.resolve()):rea.tabs.getSelected(null,function(e){var h;"open-dashboard"==d?h=rea.extension.getURL("options.html")+"#nav=dashboard":"open-dashboard-with-running-scripts"==d?h=rea.extension.getURL("options.html")+
"#nav=dashboard&filter="+encodeURIComponent(e.url):"open-new-script"==d&&(h=rea.extension.getURL("options.html")+"#url="+J.Base64.encode(e.url)+"&nav=new-user-script");n.resolve(h?{url:h,active:!0,parent:e}:null)});return n.promise()})().then(function(d){d&&rea.tabs.create(d)})},sa=function(){var d=[],m=function(c,a,b){F.late?("auto"==e.values.scriptUrlDetection&&oa.isScriptUrl(b.url)&&w.installFromUrl(b.url),b.url?"loading"==a.status?C.events.loading(b.id,0,b.url):"complete"==a.status&&C.events.complete(b.id,
0,b.url):n.warn("tabUpdates: no tab url set! ",b),d.forEach(function(c){c({reason:"updated",status:a.status},b)})):window.setTimeout(function(){m(c,a,b)},100)},f=function(c,a){Y[c]&&(Y[c].onClose(),delete Y[c]);C.events.remove(c);d.forEach(function(a){a({reason:"removed"},{id:c})})},h=function(c,a){f(a,{});Q.setIcon(c);Q.setBadge(c);d.forEach(function(a){a({reason:"replaced"},c)})},l={init:function(){rea.tabs.onUpdated.addListener(m);rea.tabs.onRemoved.addListener(f);rea.tabs.onReplaced.addListener(h)},
openAndWatch:function(c,a){var b=null,d=function(c,e){null!==b&&e.id===b&&("updated"==c.reason?a(e):"removed"==c.reason&&(l.removeListener(d),a()))};rea.tabs.create(c,function(c){b=c.id;a(c)});l.addListener(d);return{cancel:function(){l.removeListener(d);null!==b&&(rea.tabs.remove(b,function(){}),b=null)}}},addListener:function(c){d.push(c)},removeListener:function(c){var a;d&&-1<(a=d.indexOf(c))&&d.splice(a,1)}};return l}(),za=function(){var d="temporary"==e.values.incognito_mode&&rea.extension.inIncognitoContext;
u.setTemporary(d);d&&(e.values.native_import=!1,e.values.sync_enabled=!1,e.values.scriptUpdateCheckPeriod=0,e.values.sync_type=0,e.values.statistics_enabled=!1)},Ja=function(){n.set(e.values.logLevel);d.setLocale(e.values.i18n);N.setPath(e.values.native_import_path);pa=Registry.get("xmlhttprequest",q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&"no"!=e.values.webrequest_modHeaders?ea.getPrefix():null,q.RUNTIME.FIREFOX);la=pa.run;L.init("bg",rea.extension.manifest.version);L.setEnabled(e.values.statistics_enabled);
C.listeners.add.onReset(function(d,e){ca.clearByTabId(d);z.removeStorageListeners({tabid:d},!1);e||Q.setIcon(d)});var m=function(d){rea.tabs.get(d,function(e){!rea.runtime.lastError&&e&&(Q.setIcon(d),Q.setBadge(d))})};C.listeners.add.onCommited(m);C.listeners.add.onCompleted(m);C.listeners.add.onCompleted(fa.purgeAppeals);C.listeners.add.onRemoved(fa.purgeAppeals);K.init().done(function(d){d&&K.sync()});T.init();S.init();z.init();m=function(){H.set_mode(e.values.downloads_mode);H.set_whitelist(e.values.downloads_extension_whitelist)};
m();H.config_changed_listener=m;Ga.init();qa.init();ea.init();ka.init();ba.init();aa.init()},J,la,pa,na,D,G,ga;init=function(){F.init();ea.init(!0);sa.init();wa.init();rea.commands.supported&&rea.commands.onCommand.addListener(Ia);Ha.init(function(){K.finalize()});J=Registry.get("convert");na=Registry.get("compat",q);D=Registry.get("parser");G=Registry.get("syncinfo",sa);ga=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});
rea.browserAction.setTitle({title:"Tampermonkey"});u.init().then(function(){return Ca()}).then(function(){return e.init()}).then(function(){cfgo=e;za();Ja();Ea();Q.init();window.setTimeout(aa.check,1E4);n.debug("Listeners registered!");window.setTimeout(F.setReady,1);if(ga&&Registry.isDevVersion("test")){var d=ga.framework.prepare(w.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION);d&&n.error(d)}})};init()}});
