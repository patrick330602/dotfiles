"use strict";var config={playResX:560,playResY:420,fontlist:["PingFang SC","Source Han Sans CN","Microsoft YaHei UI","Microsoft YaHei","文泉驿正黑","STHeitiSC","黑体"],font_size:1,r2ltime:8,fixtime:4,opacity:.6,space:0,max_delay:6,bottom:50,use_canvas:null,debug:!1},debug=config.debug?console.log.bind(console):function(){},fillStr=function(a){var b=Array.apply(Array,arguments);return a.replace(/{{([^}]+)}}/g,function(a,c){var d=void 0;return b.some(function(a){return d=a[c]}),d||""})},RRGGBB=function(a){var b=Number(a).toString(16).toUpperCase();return b.length>6&&(b=b.substr(1)),Array(7-b.length).join("0")+b},hexAlpha=function(a){var b=Math.round(255*(1-a)).toString(16).toUpperCase();return Array(3-b.length).join("0")+b},hypot=Math.hypot?Math.hypot.bind(Math):function(){return Math.sqrt([0].concat(Array.apply(Array,arguments)).reduce(function(a,b){return a+b*b}))},startDownload=function(a,b){var c=new Blob([a],{type:"application/octet-stream"}),d=window.URL.createObjectURL(c),e=document.createElement("a");e.href=d,e.style.display="none",document.body.appendChild(e),e.download=b,e.click(),setTimeout(function(){e.parentNode.removeChild(e)},1e3),document.addEventListener("unload",function(){window.URL.revokeObjectURL(d)})},calcWidth=function(){var a=function(){var a=document.createElement("canvas"),b=a.getContext("2d");return function(a,c,d){return b.font="bold "+d+"px "+a,Math.ceil(b.measureText(c).width+config.space)}},b=function(){var a=document.createElement("div");a.setAttribute("style",["all: unset","top: -10000px","left: -10000px","width: auto","height: auto","position: absolute",""].join(" !important; "));var b=function(){document.body.parentNode.appendChild(a)};return document.body?b():document.addEventListener("DOMContentLoaded",b),function(b,c,d){return a.textContent=c,a.style.font="bold "+d+"px "+b,a.clientWidth+config.space}};return null===config.use_canvas&&navigator.platform.match(/linux/i)&&!navigator.userAgent.match(/chrome/i)&&(config.use_canvas=!1),debug("use canvas: %o",config.use_canvas!==!1),config.use_canvas===!1?b():a()}(),choseFont=function(a){var b="The quick brown fox jumps over the lazy dog7531902468,.!-，。：！天地玄黄則近道矣",c=["monospace","sans-serif","sans","Symbol","Arial","Comic Sans MS","Fixed","Terminal","Times","Times New Roman","宋体","黑体","文泉驿正黑","Microsoft YaHei","PingFang SC"],d=function(a,c){var d=calcWidth(a,b,72),e=calcWidth(c+","+a,b,72);return d!==e},e=function(a){var b=c.some(function(b){return d(b,a)});return debug("font %s: %o",a,b),b},f=a[a.length-1];return a=a.filter(e),debug("fontlist: %o",a),a[0]||f},initFont=function(){var a=!1;return function(){a||(a=!0,calcWidth=calcWidth.bind(window,config.font=choseFont(config.fontlist)))}}(),generateASS=function(a,b){var c=fillStr("[Script Info]\nTitle: {{title}}\nOriginal Script: 根据 {{ori}} 的弹幕信息，由 https://github.com/tiansh/us-danmaku 生成\nScriptType: v4.00+\nCollisions: Normal\nPlayResX: {{playResX}}\nPlayResY: {{playResY}}\nTimer: 10.0000\n\n[V4+ Styles]\nFormat: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding\nStyle: Fix,{{font}},25,&H{{alpha}}FFFFFF,&H{{alpha}}FFFFFF,&H{{alpha}}000000,&H{{alpha}}000000,1,0,0,0,100,100,0,0,1,2,0,2,20,20,2,0\nStyle: R2L,{{font}},25,&H{{alpha}}FFFFFF,&H{{alpha}}FFFFFF,&H{{alpha}}000000,&H{{alpha}}000000,1,0,0,0,100,100,0,0,1,2,0,2,20,20,2,0\n\n[Events]\nFormat: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\n",config,b,{alpha:hexAlpha(config.opacity)}),d=function(a,b){for(a=""+a;a.length<b;)a="0"+a;return a},e=function(a){a=100*a^0;var b=[[100,2],[60,2],[60,2],[1/0,0]].map(function(b){var c=a%b[0];return a=(a-c)/b[0],d(c,b[1])}).reverse();return b.slice(0,-1).join(":")+"."+b[3]},f=function(){var a=function(a){var b="",c=a.color.split(/(..)/).filter(function(a){return a}).map(function(a){return parseInt(a,16)});"FFFFFF"!==a.color&&(b+="\\c&H"+a.color.split(/(..)/).reverse().join(""));var d=.299*c[0]+.587*c[1]+.114*c[2]<48;return d&&(b+="\\3c&HFFFFFF"),25!==a.size&&(b+="\\fs"+a.size),b},b=function(a){return"\\move("+[a.poss.x,a.poss.y,a.posd.x,a.posd.y].join(",")+")"},c=function(a){return"\\pos("+[a.poss.x,a.poss.y].join(",")+")"},d=function(b){return function(c){return b(c)+a(c)}};return{R2L:d(b),Fix:d(c)}}(),g=function(a){return a.replace(/{/g,"｛").replace(/}/g,"｝").replace(/\r|\n/g,"")},h=function(a){return"Dialogue: "+[0,e(a.stime),e(a.dtime),a.type,",20,20,2,,"].join(",")+"{"+f[a.type](a)+"}"+g(a.text)};return c+a.map(h).filter(function(a){return a}).join("\n")},normalDanmaku=function(a,b,c,d,e){return function(){var f=[{p:-(1/0),m:0,tf:1/0,td:1/0,b:!1},{p:b,m:1/0,tf:1/0,td:1/0,b:!1},{p:b-c,m:b,tf:1/0,td:1/0,b:!0}],g=function(a,c,d,g){var h=[];f.forEach(function(e){if(!(e.m>b)){var i=e.m,j=i+a,k=c,l=d;f.forEach(function(a){a.p>=j||a.m<=i||a.b&&g||(k=Math.max(k,a.tf),l=Math.max(l,a.td))}),h.push({p:i,r:Math.max(k-c,l-d)})}}),h.sort(function(a,b){return a.p-b.p});var i=e;return h=h.filter(function(a){return!(a.r>=i)&&(i=a.r,!0)})},h=function(a,b,c,d){f.push({p:a,m:b,tf:c,td:d,b:!1})},i=function(a,b){f=f.filter(function(c){return c.tf>a||c.td>b})},j=function(a){return a.r>e?-(1/0):1-hypot(a.r/e,a.p/b)*Math.SQRT1_2};return function(b,c,e,f){var k=a/(c+a)*d+b;i(b,k);var l=g(e,b,k,f);if(!l.length)return null;var m=l.map(function(a){return[j(a),a]}),n=m.reduce(function(a,b){return a[0]>b[0]?a:b})[1],o=b+n.r,p=c/(c+a)*d+o,q=d+o;return h(n.p,n.p+e,p,q),{top:n.p,time:o}}}}(config.playResX,config.playResY,config.bottom,config.r2ltime,config.max_delay),sideDanmaku=function(a,b,c,d){return function(){var e=[{p:-(1/0),m:0,td:1/0,b:!1},{p:a,m:1/0,td:1/0,b:!1},{p:a-b,m:a,td:1/0,b:!0}],f=function(a,b,c,d){var f=c;return e.forEach(function(c){c.p>=b||c.m<=a||c.b&&d||(f=Math.max(f,c.td))}),{r:f-c,p:a,m:b}},g=function(b,c,d){var g=[];return e.forEach(function(e){e.m>a||g.push(f(e.m,e.m+b,c,d))}),g},h=function(a,b,c){var d=[];return e.forEach(function(e){e.p<0||d.push(f(e.p-a,e.p,b,c))}),d},i=function(a,b,c){e.push({p:a,m:b,td:c,b:!1})},j=function(a){e=e.filter(function(b){return b.td>a})},k=function(b,c){if(b.r>d)return-(1/0);var e=function(b){return c?b:a-b};return 1-(b.r/d*(31/32)+e(b.p)/a*(1/32))};return function(a,b,d,e){j(a);var f=(d?g:h)(b,a,e);if(!f.length)return null;var l=f.map(function(a){return[k(a,d),a]}),m=l.reduce(function(a,b){return a[0]>b[0]?a:b})[1];return i(m.p,m.m,m.r+a+c),{top:m.p,time:m.r+a}}}}(config.playResY,config.bottom,config.fixtime,config.max_delay),setPosition=function(a){var b=normalDanmaku(),c=sideDanmaku();return a.sort(function(a,b){return a.time-b.time}).map(function(a){var d=Math.round(a.size*config.font_size),e=calcWidth(a.text,d);switch(a.mode){case"R2L":return function(){var c=b(a.time,e,d,a.bottom);return c?(a.type="R2L",a.stime=c.time,a.poss={x:config.playResX+e/2,y:c.top+d},a.posd={x:-e/2,y:c.top+d},a.dtime=config.r2ltime+a.stime,a):null}();case"TOP":case"BOTTOM":return function(b){var e=c(a.time,d,b,a.bottom);return e?(a.type="Fix",a.stime=e.time,a.posd=a.poss={x:Math.round(config.playResX/2),y:e.top+d},a.dtime=config.fixtime+a.stime,a):null}("TOP"===a.mode);default:return null}}).filter(function(a){return a}).sort(function(a,b){return a.stime-b.stime})},parseXML=function(a,b){var b=b||(new DOMParser).parseFromString(a,"text/xml");return Array.apply(Array,b.querySelectorAll("d")).map(function(a){var b=a.getAttribute("p").split(","),c=a.textContent;return{text:c,time:Number(b[0]),mode:[void 0,"R2L","R2L","R2L","BOTTOM","TOP"][Number(b[1])],size:Number(b[2]),color:RRGGBB(Number(b[3])),bottom:Number(b[5])>0}})},getCid=function a(b){debug("get cid...");var c=null,d=null;try{d=document.querySelector("#bofqi iframe").src.replace(/^.*\?/,""),c=Number(d.match(/cid=(\d+)/)[1])}catch(e){}if(!c)try{d=document.querySelector("#bofqi embed").getAttribute("flashvars"),c=Number(d.match(/cid=(\d+)/)[1])}catch(e){}if(!c)try{d=document.querySelector('#bofqi object param[name="flashvars"]').getAttribute("value"),c=Number(d.match(/cid=(\d+)/)[1])}catch(e){}c?setTimeout(b,0,c):d?GM_xmlhttpRequest({method:"GET",url:"http://interface.bilibili.com/player?"+d,onload:function(a){try{c=Number(a.responseText.match(/<chatid>(\d+)<\/chatid>/)[1])}catch(d){}setTimeout(b,0,c||void 0)},onerror:function(){setTimeout(b,0)}}):setTimeout(a,100,b)},mina=function(a){getCid(function(b){b=b||a,fetchDanmaku(b,function(a){var c=void 0;try{c=document.querySelector(".viewbox h1, .viewbox h2").textContent}catch(d){c=""+b}debug("got xml with %d danmaku",a.length);var e=generateASS(setPosition(a),{title:document.title,ori:location.href});startDownload("\ufeff"+e,c+".ass")})})};initFont();