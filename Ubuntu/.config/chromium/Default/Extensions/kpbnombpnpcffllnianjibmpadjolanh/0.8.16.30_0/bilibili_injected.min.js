"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};!function(){function a(a,b){for(var c="",d=1;d<=b-(a+"").length;d++)c+="0";return c+a}function b(a){return(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function c(b){return a(parseInt(b/6e4),2)+":"+a(parseInt(b/1e3%60),2)}function d(a,b){var c=document.createElement("link");c.setAttribute("id",a),c.setAttribute("type","text/css"),c.setAttribute("rel","stylesheet"),c.setAttribute("href",chrome.extension.getURL(b)),document.head?document.head.appendChild(c):document.documentElement.appendChild(c)}function e(){chrome.runtime.sendMessage({command:"getAd"},function(a){"on"===a.value&&d("bilibiliHelperAdStyle","bilibiliHelperAd.min.css")})}function f(){d("bilibiliHelperVideo","bilibiliHelperVideo.min.css"),$(".arc-toolbar .helper .t .icon").css("background-image","url("+chrome.extension.getURL("imgs/helper-neko.png")+")")}function g(a){console.warn("side:"+k.site,"mode:"+a);var b=$("#bilibiliPlayer"),c=function(){if("wide"!==a||b.hasClass("mode-widescreen")){if("webfullscreen"===a&&!b.hasClass("mode-webfullscreen")){var c=$(".bilibili-player-iconfont-web-fullscreen");console.warn(c.length),0===c.length||c.length>0&&c.click()}}else{var d=$(".bilibili-player-iconfont-widescreen");if(0===d.length){var e=$("#player_placeholder").find("param[name=flashvars]");e.val(e.val()+"&as_wide=1"),$("#player_placeholder").attr("data",$("#player_placeholder").attr("data"))}else d.click()}};if($("#player_placeholder > *").length>0)c();else{var d=new MutationObserver(function(){c(),d.disconnect()});$("#bofqi").length>0?d.observe($("#bofqi")[0],{childList:!0}):$("#bilibiliPlayer").length>0&&d.observe($("#bilibiliPlayer")[0],{childList:!0})}}function h(){"scrollRestoration"in history&&(history.scrollRestoration="manual",$(document).scrollTop($(".player-wrapper").offset().top))}function i(a,b,c,d,e){var f="av"+a+"_",g=c&&c>1?"p"+b+"_":"",h="",i=e&&e>1?""+d+"_":"";return g&&(h=$(".player-wrapper #plist > span").text(),h=h.substr(h.indexOf("、")+1)+"_"),f+g+h+i+$("div.v-title").text()}function j(a,b){var c=null,d=a.split(/[\\/]/).pop().split("?")[0],e=d.match(/[.]/)?d.match(/[^.]+$/):"mp4";switch(e){case"letv":e="flv"}return c=filenameSanitize(b,{replacement:"_",max:255-e.length-1})+"."+e,{url:a,filename:c}}if($("html").hasClass("bilibili-helper"))return!1;if(!store.enabled)return!1;store.set("defaulth5",1),store["delete"]=function(a,b){if(void 0!==a){var c=store.get(a);void 0!==c&&(void 0!==b&&null!==b?"string"!=typeof b&&"number"!=typeof b||(c[b]&&delete c[b],store.set(a,c)):store.remove(a))}};var k={};if(k.eval=function(a){var b=Function;return new b("return "+a)()},"/blackboard/html5player.html"===document.location.pathname||"/blackboard/html5playerbeta.html"===document.location.pathname)k.site=2;else if("bangumi.bilibili.com"===location.hostname)k.site=1,k.sameVideo=!1;else{if("www.bilibili.com"!==location.hostname)return!1;k.site=0}k.protocol=location.protocol,e(),chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.command){case"update":return e(),c({result:"ok"}),!0;case"error":return!0;default:return c({result:"unknown"}),!1}});var l=function(a){return a.replace(/platform=bilihelper&?/,"")},m=function(){chrome.runtime.sendMessage({command:"getDownloadLink",cid:k.cid},function(a){var d=a.download,e=a.playback;if(k.downloadUrls=[],k.playbackUrls=[],"undefined"==typeof d.durl.url?k.downloadUrls=d.durl:k.downloadUrls.push(d.durl),"undefined"==typeof e.durl||"undefined"==typeof e.durl.url?k.playbackUrls=e.durl:k.playbackUrls.push(e.durl),"object"===_typeof(k.downloadUrls)&&k.downloadUrls.length){k.mainBlock.downloaderSection.find("p").empty();for(var f=0;f<k.downloadUrls.length;f++){var g=k.downloadUrls[f];if("object"===("undefined"==typeof g?"undefined":_typeof(g))){var h=j(l(g.url),i(k.avid,k.page,k.totalPage,f,k.downloadUrls.length)),m=$('<a class="b-btn w" rel="noreferrer"></a>').text("分段 "+(parseInt(f)+1)).data("download",h.filename).attr("title",isNaN(parseInt(g.filesize/1048576+.5))?"长度: "+c(g.length):"长度: "+c(g.length)+" 大小: "+parseInt(g.filesize/1048576+.5)+" MB").attr("href",l(g.url));k.mainBlock.downloaderSection.find("p").append(m),m.click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).data("download")})})}}if(k.downloadUrls.length>1){var n=$('<a class="b-btn"></a>').text("下载全部共 "+k.downloadUrls.length+" 个分段");k.mainBlock.downloaderSection.find("p").append(n),n.click(function(a){k.mainBlock.downloaderSection.find("p .b-btn.w").click()})}}else{var o=k.error||"视频地址获取失败";k.mainBlock.downloaderSection.find("p").html("<span></span>"+b(o))}})},n=function(){k.videoPic=$("img.cover_image").attr("src"),k.totalPage=$("#dedepagetitles option").length,$(".v1-bangumi-info-operate .helper").remove(),"undefined"==typeof k.page?k.page=1:k.page=parseInt(k.page),k.pageOffset=0,chrome.runtime.sendMessage({command:"init"},function(a){k.version=a.version,k.autowide=a.autowide,k.autooffset=a.autooffset,k.originalPlayer=localStorage.getItem("bilimac_original_player")||$("#bofqi").html(),localStorage.removeItem("bilimac_original_player"),k.switcher={current:"original",set:function(a){k.mainBlock.switcherSection&&(k.mainBlock.switcherSection.find('a.b-btn[type="'+this.current+'"]').addClass("w"),k.mainBlock.switcherSection.find('a.b-btn[type="'+a+'"]').removeClass("w")),this.current=a},original:function(){this.set("original"),$("#bofqi").html(k.originalPlayer)},bilimac:function(){this.set("bilimac"),$("#bofqi").html('<div id="player_placeholder" class="player"></div><div id="loading-notice">正在加载 Bilibili Mac 客户端…</div>'),$("#bofqi").find("#player_placeholder").css({background:"url("+k.videoPic+") 50% 50% / cover no-repeat","-webkit-filter":"blur(20px)",overflow:"hidden",visibility:"visible"}),chrome.runtime.sendMessage({command:"callBilibiliMac",data:{action:"playVideoByCID",data:k.cid+"|"+window.location.href+"|"+document.title+"|"+(2===k.cidHack?2:1)}},function(a){a?$("#bofqi").find("#loading-notice").text("已在 Bilibili Mac 客户端中加载"):$("#bofqi").find("#loading-notice").text("调用 Bilibili Mac 客户端失败 :(")})}},0===k.site?(k.helperBlock=$('<div class="block helper" id="bilibili_helper"><span class="t"><div class="icon"></div><div class="t-right"><span class="t-right-top middle">助手</span><span class="t-right-bottom">扩展菜单</span></div></span><div class="info"><div class="main"></div><div class="version" title="'+k.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></div>'),k.helperBlock.find(".t").click(function(){k.helperBlock.toggleClass("active")})):1===k.site&&(k.helperBlock=$('<span class="helper"><div class="v1-bangumi-info-btn" id="bilibili_helper">哔哩哔哩助手</div><div class="info"><div class="main"></div><div class="version" title="'+k.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></span>'),k.helperBlock.find(".v1-bangumi-info-btn").click(function(){k.helperBlock.toggleClass("active")}));var b=k.helperBlock.find(".info");k.mainBlock=b.find(".main"),k.mainBlock.infoSection=$('<div class="section video hidden"><h3>视频信息</h3><p><span></span><span>aid: '+k.avid+"</span><span>pg: "+k.page+"</span></p></div>"),k.mainBlock.append(k.mainBlock.infoSection),k.mainBlock.dblclick(function(a){a.shiftKey&&k.mainBlock.infoSection.toggleClass("hidden")}),localStorage.getItem("bilimac_player_type")&&(k.mainBlock.switcherSection=$('<div class="section switcher"><h3>播放器切换</h3><p></p></div>'),k.mainBlock.switcherSection.find("p").append($('<a class="b-btn w" type="original">原始播放器</a><a class="b-btn w" type="bilimac">Mac 客户端</a>').click(function(){k.switcher[$(this).attr("type")]()})),k.mainBlock.append(k.mainBlock.switcherSection)),k.mainBlock.downloaderSection=$('<div class="section downloder"><h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p></div>'),k.mainBlock.append(k.mainBlock.downloaderSection),k.mainBlock.querySection=$('<div class="section query"><h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p></div>'),k.mainBlock.append(k.mainBlock.querySection),k.switcher.set("original"),"off"!==a.autowide&&g(a.autowide),0===k.site?$(".player-wrapper .arc-toolbar").append(k.helperBlock):1===k.site&&$(".v1-bangumi-info-operate .v1-app-btn").after(k.helperBlock),$(document).ready(u),f()})};if("function"==typeof $&&$(".player-wrapper .v-plist").length){var o=document.createElement("script");o.id="page-prob",o.innerHTML="$('.player-wrapper .v-plist').attr('length', window.VideoPart.nodedata.length);$('#page-prob').remove();",document.body.appendChild(o)}$("html").addClass("bilibili-helper");var p=void 0,q=void 0,r=void 0;if(0===k.site)p=/\/video\/av([0-9]+)\/(?:index_([0-9]+)\.html)?.*?$/,q=p.exec(document.location.pathname),r=/page=([0-9]+)/.exec(document.location.hash),r&&"object"===("undefined"==typeof r?"undefined":_typeof(r))&&!isNaN(r[1])&&(r=parseInt(r[1])),q&&(k.avid=q[1],k.page=r||q[2]),k.avid&&n();else if(1===k.site){var s=$("#bofqi")[0];if(s){var t=new MutationObserver(function(){if(($("iframe.player").length||$('.scontent object param[name="flashvars"]').length)&&(q=$('.scontent object param[name="flashvars"]').attr("value")||$("iframe.player").attr("src"))){var a=q.split("&").map(function(a){return a.split("=",2)});a.forEach(function(a){var b=a[0],c=a[1];"aid"===b?k.avid=c:"cid"===b?k.cid=c:"seasonId"===b?k.seasonId=c:"episodeId"===b&&(k.episodeId===c?k.sameVideo=!0:k.sameVideo=!1,k.episodeId=c)}),k.sameVideo===!1&&n()}});t.observe(s,{childList:!0})}}else 2===k.site&&chrome.runtime.sendMessage({command:"init"},function(a){"off"!==a.autowide&&g(a.autowide)});k.work=function(){chrome.runtime.sendMessage({command:"getVideoInfo",avid:k.avid,pg:k.page+k.pageOffset},function(a){function d(){k.mainBlock.infoSection.find("p").append($("<span>cid: "+k.cid+"</span>"));var a=$('<div class="section comment"><h3>弹幕下载</h3><p><a class="b-btn w" href="'+k.protocol+"//comment.bilibili.com/"+k.cid+'.xml">下载 XML 格式弹幕</a></p></div>'),d=k.protocol+"//comment.bilibili.com/"+k.cid+".xml",e=i(k.avid,k.page,k.totalPage,1,1),f=j(d,e).filename;a.find("a").attr("download",f).click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).attr("download")})}),k.mainBlock.commentSection=a,k.mainBlock.append(k.mainBlock.commentSection),fetch(k.protocol+"//comment.bilibili.com/"+k.cid+".xml").then(function(a){return a.text()}).then(function(a){var d=new DOMParser,e=d.parseFromString(a.replace(/(?:[\0-\x08\x0B\f\x0E-\x1F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])/g,""),"text/xml"),g="\ufeff"+generateASS(setPosition(parseXML("",e)),{title:i(k.avid,k.page,k.totalPage,1,1),ori:location.href}),h=new Blob([g],{type:"application/octet-stream"}),j=window.URL.createObjectURL(h),l=$('<a class="b-btn w">下载 ASS 格式弹幕</a>').attr("download",f.replace(".xml",".ass")).attr("href",j).data("data",g).click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",data:$(a.target).data("data"),url:$(a.target).attr("href"),filename:$(a.target).attr("download")})});k.mainBlock.commentSection.find("p").append(l),k.comments=e.getElementsByTagName("d");var m=$('<div><input type="text" class="b-input" placeholder="根据关键词筛选弹幕"><div class="b-slt"><span class="txt">请选择需要查询的弹幕…</span><div class="b-slt-arrow"></div><ul class="list"><li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li></ul></div><span></span><span class="result">选择弹幕查看发送者…</span></div>');m.find(".b-input").keyup(function(){var a=m.find("input").val(),d=new RegExp(b(a),"gi");m.find("ul.list").html('<li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li>'),"请选择需要查询的弹幕"!==m.find(".b-slt .txt").text()&&""!==a.trim()&&m.find(".b-slt .txt").html(b(m.find(".b-slt .txt").text())),""!==a.trim()&&m.find(".b-slt .txt").text(m.find(".b-slt .txt").text());for(var e=m.find("ul.list"),f=0;f<k.comments.length;f++){var g=k.comments[f],h=g.childNodes[0];if(h&&g&&d.test(h.nodeValue)){h=h.nodeValue;var i=$("<li></li>"),j=g.getAttribute("p").split(","),l=void 0,n=void 0,o=void 0;void 0===k.comments[f].senderUsername?(l=j[6],k.comments[f].senderUsername=l):l=k.comments[f].senderUsername,void 0===k.comments[f].time?(n=c(1e3*parseInt(j[0])),k.comments[f].time=n):n=k.comments[f].time,void 0===k.comments[f].originalContent?(o=b(h),k.comments[f].originalContent=o):o=k.comments[f].originalContent;var p="["+n+"] ";i.attr({sender:l,index:f}),p+=""===a.trim()?o:o.replace(d,function(a){return'<span class="kw">'+a+"</span>"}),i.append(p).attr("title",o),g.error===!0&&i.addClass("error"),e.append(i)}}var q=document.createElement("script");q.appendChild(document.createTextNode('UserCard.bind($("#bilibili_helper .query .list .result"));')),document.body.appendChild(q),q.parentNode.removeChild(q),m.find(".b-slt .list li").on("click",function(a){$(".b-slt .list").hide(),k.selectedDanmu&&k.selectedDanmu.removeClass("selected");var c=$(a.target);k.selectedDanmu=c,k.selectedDanmu.addClass("selected");var d=c.attr("sender"),e=c.attr("index");if(m.find(".result").text("查询中…"),0===d.indexOf("D"))return void m.find(".result").text("游客弹幕");var f=function(a,c){k.comments[e].senderId=a,k.comments[e].senderUsername=b(c.name),m.find(".result").html('发送者: <a href="'+k.protocol+"//space.bilibili.com/"+a+'" target="_blank" data-usercard-mid="'+a+'">'+b(c.name)+'</a><div target="_blank" class="user-info-level l'+b(c.level_info.current_level)+'"></div>');var d=document.createElement("script");d.appendChild(document.createTextNode('UserCard.bind($("#bilibili_helper .query .result"));')),document.body.appendChild(d),d.parentNode.removeChild(d)},g=function(a){m.find(".result").html('发送者 UID: <a href="'+k.protocol+"//space.bilibili.com/"+a+'" target="_blank">'+a+"</a>");var b=sessionStorage.getItem("user/"+a);b?f(a,JSON.parse(b)):$.getJSON(k.protocol+"//api.bilibili.com/cardrich?mid="+a+"&type=json",function(b){if(0===b.code){var c=b.data.card;sessionStorage.setItem("user/"+a,JSON.stringify({name:c.name,level_info:{current_level:c.level_info.current_level}})),f(a,c)}})},h=/^b(\d+)$/.exec(d);h?g(h[1]):$.get("https://biliquery.typcn.com/api/user/hash/"+d,function(a){a&&0===a.error&&"object"===_typeof(a.data)&&a.data[0].id?g(a.data[0].id):(m.find(".result").text("查询失败, 发送用户可能已被管理员删除."),c.addClass("error"),k.comments[e].error=!0)},"json").fail(function(){m.find(".result").text("查询失败, 无法连接到服务器 :(")})})}),m.find(".b-input").keyup(),m.find(".b-slt").on("mouseover",function(){$(".b-slt .list").show()}).on("mouseleave",function(){$(".b-slt .list").hide()}),k.mainBlock.querySection.find("p").empty().append(m)})}var e=a.videoInfo;if("number"==typeof e.cid&&0===$(".b-page-body .viewbox").length&&0===$(".main-inner .viewbox").length&&(k.genPage=!0,k.copyright=!0),k.videoPic=e.pic,"number"==typeof k.totalPage&&k.totalPage>e.pages&&k.pageOffset>e.pages-k.totalPage)return k.pageOffset=e.pages-k.totalPage,k.work(),!1;"off"!==k.autowide&&g(k.autowide),"on"===k.autooffset&&h(),"undefined"!=typeof e.code?1!==k.page?chrome.runtime.sendMessage({command:"getVideoInfo",avid:k.avid,pg:1,isBangumi:1===k.site},function(a){var b=a.videoInfo;if(b.pages===k.page-1)return k.pageOffset-=1,k.work(),!1}):(k.error="错误"+e.code+": "+e.error,k.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+b(k.error)+"</span></p></div>"),k.mainBlock.append(k.mainBlock.errorSection),$("#loading-notice").fadeOut(300)):(void 0===k.cid&&(k.cid=e.cid),1===k.site?chrome.runtime.sendMessage({command:"getBangumiInfo",episodeId:k.episodeId},function(a){k.avid=a.videoInfo.avid,k.cid=a.videoInfo.danmaku,k.index=a.videoInfo.index,d()}):d());var f=null;return window.postMessage?(f=function(a){"https://secure.bilibili.com"!==a.origin&&"https://ssl.bilibili.com"!==a.origin||"secJS:"!==a.data.substr(0,6)||k.eval(a.data.substr(6))},window.addEventListener?window.addEventListener("message",f,!1):window.attachEvent&&window.attachEvent("onmessage",f)):setInterval(function(){var a=window.__GetCookie("__secureJS");window.__SetCookie("__secureJS",""),k.eval(a)},1e3),k.cid?void m():(k.error="错误"+e.code+": "+e.error,k.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+b(k.error)+"</span></p></div>"),k.mainBlock.append(k.mainBlock.errorSection),!1)})};var u=function(){k.totalPage=$(".player-wrapper .v-plist").attr("length"),isNaN(k.totalPage)||(k.totalPage=parseInt(k.totalPage)),"force"===localStorage.getItem("bilimac_player_type")&&k.switcher.set("bilimac"),localStorage.removeItem("bilimac_player_type"),k.replacePlayer=!1,k.work(),window.addEventListener("hashchange",function(){var a=/page=([0-9]+)/.exec(document.location.hash);a&&"object"===("undefined"==typeof a?"undefined":_typeof(a))&&!isNaN(a[1])&&(a=parseInt(a[1])),a&&a!==k.page&&(k.page=a,k.mainBlock.infoSection.html("<h3>视频信息</h3><p><span></span><span>aid: "+k.avid+"</span><span>pg: "+k.page+"</span></p>"),k.mainBlock.downloaderSection.html("<h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p>"),k.mainBlock.querySection.html("<h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p>"),k.mainBlock.commentSection&&k.mainBlock.commentSection.remove(),k.mainBlock.errorSection&&k.mainBlock.errorSection.remove(),k.work())},!1)}}(),function(){if("/video/bgm_calendar.html"===location.pathname)for(var a=$("#bangumi"),b=(new Date).getDay()-1,c=0;c<7&&a.children()[0].getAttribute("weekday")!==b;++c){var d=a.children()[0];a.children()[0].remove(),a.append(d)}}();